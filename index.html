<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>
   THUNDERXPAY
  </title>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js">
   function sendReward() {
  const ru = document.getElementById("rewardUser").value.trim();
  const ra = document.getElementById("rewardAmount").value.trim();
  const rm = document.getElementById("rewardMessage").value.trim();
  if (!ru || !ra || !rm) return alert("Please fill all fields.");

  const now = new Date().toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  }).replace(',', '');

  const rewardData = {
    amount: ra,
    message: rm,
    time: now,
    from: "Owner"
  };

  const rewardKey = db.ref(`thunderPayUsers/${ru}/mailbox`).push().key;
  db.ref(`thunderPayUsers/${ru}/mailbox/${rewardKey}`).set(rewardData)
    .then(() => {
      alert("üéÅ Reward sent to " + ru + "'s mailbox!");
      document.getElementById("rewardUser").value = "";
      document.getElementById("rewardAmount").value = "";
      document.getElementById("rewardMessage").value = "";
    })
    .catch(err => alert("‚ùå Failed to send reward: " + err.message));
}


function loadMailboxMessages() {
  const container = document.getElementById("mailboxDisplay");
  container.innerHTML = '<p class="no-messages">Loading...</p>';

  db.ref(`thunderPayUsers/${user}/mailbox`).once("value", snap => {
    container.innerHTML = "";
    if (!snap.exists()) {
      container.innerHTML = '<p class="no-messages">No messages in your mailbox.</p>';
      return;
    }

    const all = snap.val();
    Object.entries(all).reverse().forEach(([key, data]) => {
      const item = document.createElement("div");
      item.className = "mailbox-message-item";
      item.innerHTML = `
        <h4>üéÅ Reward from ${data.from || 'Unknown'}</h4>
        <p>${data.message}</p>
        <p><b>Amount / Gift:</b> ‚Çπ${data.amount}</p>
        <p class="timestamp">${data.time}</p>
        <button onclick="claimReward('${key}', '${data.amount}')">üéâ Claim</button>
      `;
      container.appendChild(item);
    });
  });
}

function claimReward(key, amt) {
  const amount = parseInt(amt);
  if (!user || !key || isNaN(amount)) return alert("Invalid reward data.");

  db.ref("thunderPayUsers/" + user).once("value", snap => {
    if (!snap.exists()) return alert("User not found.");
    const bal = snap.val().balance || 0;
    const now = new Date().toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const updates = {};
    updates[`thunderPayUsers/${user}/balance`] = bal + amount;
    updates[`thunderPayUsers/${user}/history/${db.ref().push().key}`] = `${now} | Got ‚Çπ${amount} from Owner Reward`;
    updates[`thunderPayUsers/${user}/mailbox/${key}`] = null;

    db.ref().update(updates).then(() => {
      
    
      loadMailboxMessages();
      showPaymentSuccessAnimation();
    });
  });
}


function saveProfileEmoji() {
  const emoji = document.getElementById("profileEmojiSelect").value;
  db.ref(`thunderPayUsers/${user}/emoji`).set(emoji).then(() => {
    alert("‚úÖ Emoji Saved!");
    loadMyProfile();
  });
}

function loadMyProfile() {
  db.ref(`thunderPayUsers/${user}`).once("value", snap => {
    const data = snap.val();
    const emoji = data.emoji || "";
    const username = user;
    document.getElementById("myProfileUsername").innerHTML = username + (data.verified ? '<span class="verified-badge">‚úì</span>' : "");
    document.getElementById("myProfileInitial").textContent = emoji || username.charAt(0).toUpperCase();
    document.getElementById("profileBio").value = data.bio || "";
    document.getElementById("myProfileFollowers").textContent = data.followers ? Object.keys(data.followers).length : 0;
    document.getElementById("myProfileFollowing").textContent = data.following ? Object.keys(data.following).length : 0;
    if (document.getElementById("profileEmojiSelect")) {
      document.getElementById("profileEmojiSelect").value = emoji;
    }
  });
}


function monitorMailbox() {
  if (!user) return;
  const dot = document.getElementById("mailboxDot");
  const gift = document.getElementById("giftIcon");
  db.ref(`thunderPayUsers/${user}/mailbox`).on("value", snap => {
    if (snap.exists()) {
      dot.classList.remove("hidden");
      gift.style.display = "inline";
    } else {
      dot.classList.add("hidden");
      gift.style.display = "none";
    }
  });
}
  </script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js">
   function sendReward() {
  const ru = document.getElementById("rewardUser").value.trim();
  const ra = document.getElementById("rewardAmount").value.trim();
  const rm = document.getElementById("rewardMessage").value.trim();
  if (!ru || !ra || !rm) return alert("Please fill all fields.");

  const now = new Date().toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  }).replace(',', '');

  const rewardData = {
    amount: ra,
    message: rm,
    time: now,
    from: "Owner"
  };

  const rewardKey = db.ref(`thunderPayUsers/${ru}/mailbox`).push().key;
  db.ref(`thunderPayUsers/${ru}/mailbox/${rewardKey}`).set(rewardData)
    .then(() => {
      alert("üéÅ Reward sent to " + ru + "'s mailbox!");
      document.getElementById("rewardUser").value = "";
      document.getElementById("rewardAmount").value = "";
      document.getElementById("rewardMessage").value = "";
    })
    .catch(err => alert("‚ùå Failed to send reward: " + err.message));
}


function loadMailboxMessages() {
  const container = document.getElementById("mailboxDisplay");
  container.innerHTML = '<p class="no-messages">Loading...</p>';

  db.ref(`thunderPayUsers/${user}/mailbox`).once("value", snap => {
    container.innerHTML = "";
    if (!snap.exists()) {
      container.innerHTML = '<p class="no-messages">No messages in your mailbox.</p>';
      return;
    }

    const all = snap.val();
    Object.entries(all).reverse().forEach(([key, data]) => {
      const item = document.createElement("div");
      item.className = "mailbox-message-item";
      item.innerHTML = `
        <h4>üéÅ Reward from ${data.from || 'Unknown'}</h4>
        <p>${data.message}</p>
        <p><b>Amount / Gift:</b> ‚Çπ${data.amount}</p>
        <p class="timestamp">${data.time}</p>
        <button onclick="claimReward('${key}', '${data.amount}')">üéâ Claim</button>
      `;
      container.appendChild(item);
    });
  });
}

function claimReward(key, amt) {
  const amount = parseInt(amt);
  if (!user || !key || isNaN(amount)) return alert("Invalid reward data.");

  db.ref("thunderPayUsers/" + user).once("value", snap => {
    if (!snap.exists()) return alert("User not found.");
    const bal = snap.val().balance || 0;
    const now = new Date().toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const updates = {};
    updates[`thunderPayUsers/${user}/balance`] = bal + amount;
    updates[`thunderPayUsers/${user}/history/${db.ref().push().key}`] = `${now} | Got ‚Çπ${amount} from Owner Reward`;
    updates[`thunderPayUsers/${user}/mailbox/${key}`] = null;

    db.ref().update(updates).then(() => {
      
    
      loadMailboxMessages();
      showPaymentSuccessAnimation();
    });
  });
}


function saveProfileEmoji() {
  const emoji = document.getElementById("profileEmojiSelect").value;
  db.ref(`thunderPayUsers/${user}/emoji`).set(emoji).then(() => {
    alert("‚úÖ Emoji Saved!");
    loadMyProfile();
  });
}

function loadMyProfile() {
  db.ref(`thunderPayUsers/${user}`).once("value", snap => {
    const data = snap.val();
    const emoji = data.emoji || "";
    const username = user;
    document.getElementById("myProfileUsername").innerHTML = username + (data.verified ? '<span class="verified-badge">‚úì</span>' : "");
    document.getElementById("myProfileInitial").textContent = emoji || username.charAt(0).toUpperCase();
    document.getElementById("profileBio").value = data.bio || "";
    document.getElementById("myProfileFollowers").textContent = data.followers ? Object.keys(data.followers).length : 0;
    document.getElementById("myProfileFollowing").textContent = data.following ? Object.keys(data.following).length : 0;
    if (document.getElementById("profileEmojiSelect")) {
      document.getElementById("profileEmojiSelect").value = emoji;
    }
  });
}


function monitorMailbox() {
  if (!user) return;
  const dot = document.getElementById("mailboxDot");
  const gift = document.getElementById("giftIcon");
  db.ref(`thunderPayUsers/${user}/mailbox`).on("value", snap => {
    if (snap.exists()) {
      dot.classList.remove("hidden");
      gift.style.display = "inline";
    } else {
      dot.classList.add("hidden");
      gift.style.display = "none";
    }
  });
}
  </script>
<style>

#bottomNav {
    background: transparent !important;
    display: flex;
    justify-content: space-around;
    padding: 10px 0;
}
#bottomNav button {
    background: #0000FF;
    border: none;
    color: #fff;
    font-weight: bold;
    font-size: 1em;
    text-align: center;
    flex: none;
    padding: 8px 16px;
    border-radius: 12px;
    margin: 0 5px;
    transition: background 0.3s ease, transform 0.2s ease;
}
#bottomNav button:hover {
    background-color: #0000cc;
    transform: translateY(-2px);
}
#bottomNav button.active {
    background-color: #000099;
}


#bulkDashboardMessage {
    background: linear-gradient(135deg, #e0f7fa, #bbdefb) !important;
    color: #0277bd !important;
    font-weight: bold;
    margin: 10px auto;
    padding: 15px 20px;
    border-radius: 15px;
    max-width: 450px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    white-space: pre-wrap;
    word-wrap: break-word;
    line-height: 1.5;
    font-size: 1em;
    text-align: center;
    display: block !important;
}

   body { background: linear-gradient(to bottom, #1f2937, #334155); padding-top: 20px; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; text-align: center; margin: 0; padding-bottom: 50px; }
    input, button, textarea { padding: 12px; margin: 8px; width: 80%; max-width: 300px; border-radius: 50px; border: none; font-size: 16px; box-sizing: border-box; }
    button { background: #ffbf00; color: #000; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; }
    button:hover { background: #e0ac00; transform: translateY(-2px); }
    button:active { transform: translateY(0); }
    h1 { color: #ffbf00; margin-top: 60px; text-shadow: 0 0 5px rgba(255,191,0,0.5); margin-top: 10px; }
    h2, h3 { color: #fff; }
    .hidden { display: none; }
    .section { display: none; background: #1e293b; padding: 20px; margin: 20px auto; border-radius: 15px; width: 90%; max-width: 450px; box-shadow: 0 8px 16px rgba(0,0,0,0.4); }
    .loader { border: 6px solid #f3f3f3; border-top: 6px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
    @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

    /* Settings Button Placement */
    #settings {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: #ffbf00;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 28px;
      cursor: pointer;
      color: #000;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: background 0.3s ease, transform 0.2s ease;
      z-index: 1001;
    }
    #settings:hover { transform: scale(1.1) rotate(45deg); background: #e0ac00; }
    #settingsMenu { position: fixed; bottom: 80px; right: 20px; background: #fff; color: #000; padding: 10px; border-radius: 50px; display: none; box-shadow: 0 5px 15px rgba(0,0,0,0.6); z-index: 1000; }
    #settingsMenu button { background: #eee; color: #000; width: 100%; margin: 5px 0; padding: 10px; font-size: 15px; border-radius: 8px; position: relative; } /* Added relative for dot positioning */

    /* Notification Bell & Profile Icon */
    #notificationBell, #profileIconBtn {
      position: fixed;
      top: 15px;
      background: linear-gradient(135deg, #e0f7fa, #bbdefb) !important;
    color: #0277bd !important;
      border-radius: 50%;
      width: 45px;
      height: 45px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      cursor: pointer;
      color: #ffbf00;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      transition: background 0.3s ease, transform 0.2s ease;
      z-index: 1001;
    }
    #notificationBell { right: 15px; } /* Bell is on the rightmost */
    #profileIconBtn {
        right: 70px; /* Profile icon is next to the bell, to its left */
        font-size: 22px;
    }
    #notificationBell:hover, #profileIconBtn:hover { transform: scale(1.1); background: #4a5b70; }
    #notificationBell .dot {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 10px;
      height: 10px;
      background-color: #ef4444;
      border-radius: 50%;
      border: 1px solid #0f172a;
    }

    /* Owner Panel Blue Dot */
    #ownerDot {
        position: absolute;
        top: -3px;
        right: -3px;
        width: 12px;
        height: 12px;
        background-color: #007bff;
        border-radius: 50%;
        border: 2px solid #fff;
        z-index: 1002;
    }

    /* Payment Animation Overlay */
    #paymentAnimationOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #paymentAnimationOverlay.show {
      opacity: 1;
      visibility: visible;
    }
    .payment-tick-circle {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: linear-gradient(45deg, #00ff99, #00e676);
      display: flex;
      justify-content: center;
      align-items: center;
      animation: pop-in-bounce 0.8s ease-out forwards;
      box-shadow: 0 0 30px rgba(0,255,153,0.8);
    }
    .payment-tick-circle span {
      font-size: 70px;
      color: #0f172a;
      font-weight: bolder;
    }
    .payment-message {
      color: #fff;
      font-size: 1.8em;
      margin-top: 20px;
      opacity: 0;
      animation: fadeIn 0.5s ease-in 0.6s forwards;
      text-shadow: 0 0 10px rgba(255,255,255,0.5);
    }
    @keyframes pop-in-bounce {
      0% { transform: scale(0); opacity: 0; }
      70% { transform: scale(1.4); opacity: 1; }
      100% { transform: scale(1); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    #popup {
      position: fixed;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%);
      background: #00ffbb;
      color: #000;
      padding: 15px 25px;
      border-radius: 12px;
      display: none;
      font-weight: bold;
      z-index: 999;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      font-size: 1.1em;
    }

    /* New Tab Container for History and Chat List */
    .tab-container {
      display: flex;
      justify-content: center;
      background-color: #1e293b;
      border-radius: 50px;
      margin: 20px auto 10px;
      width: 90%;
      max-width: 450px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      overflow: hidden;
    }
    .tab-button {
      flex: 1;
      padding: 12px 0;
      background-color: transparent;
      color: #94a3b8;
      border: none;
      font-size: 1em;
      cursor: pointer;
      transition: color 0.3s ease, background-color 0.3s ease;
      text-transform: uppercase;
      font-weight: bold;
    }
    .tab-button.active {
      color: #fff;
      background-color: #334155;
      border-bottom: 3px solid #ffbf00;
    }
    .tab-button:hover:not(.active) {
      background-color: #2a384e;
    }

    /* New Transaction List Styling */
    #transactionList, #purchaseList {
      list-style: none;
      padding: 0;
      margin: 0;
      width: 100%;
    }
    .transaction-item {
      display: flex;
      align-items: center;
      background-color: #2a384e;
      padding: 15px;
      margin-bottom: 8px;
      border-radius: 50px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      transition: transform 0.2s ease;
    }
    .transaction-item:hover {
        transform: translateY(-2px);
    }

    .transaction-icon {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background-color: #3f5168;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 1.5em;
      font-weight: bold;
      color: #ffbf00;
      margin-right: 15px;
      flex-shrink: 0;
    }
    .transaction-details {
      flex-grow: 1;
      text-align: left;
    }
    .transaction-main-text {
      font-size: 1.1em;
      font-weight: bold;
      color: #fff;
    }
    .transaction-sub-text {
      font-size: 0.9em;
      color: #cbd5e1;
      margin-top: 3px;
    }
    .transaction-amount {
      font-size: 1.2em;
      font-weight: bold;
      margin-left: auto;
      text-align: right;
    }
    .transaction-date {
        font-size: 0.8em;
        color: #94a3b8;
        margin-top: 2px;
    }
    .transaction-view-code {
      background-color: #00a884;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85em;
      font-weight: bold;
      cursor: pointer;
      margin-left: 10px;
      transition: background-color 0.3s ease;
    }
    .transaction-view-code:hover {
      background-color: #008f6b;
    }

    /* Specific colors for transaction amounts */
    .amount-sent { color: #ef4444; }
    .amount-received { color: #22c55e; }
    .amount-bought { color: #3b82f6; }
    .amount-owner { color: #ffbf00; }

    #receiveCode {
        background-color: #2e3a4e;
        padding: 10px;
        border-radius: 8px;
        font-size: 1.2em;
        font-weight: bold;
        color: #00ffbb;
        word-break: break-all;
    }

    #giftResult {
        margin-top: 15px;
        padding: 10px;
        background-color: #2e3a4e;
        border-radius: 8px;
    }
    #giftCode {
        color: #00ffbb;
        font-size: 1.2em;
        word-break: break-all;
    }

    /* --- Gift Store Styles (Agal Bagal) --- */
    .gift-card-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; margin-top: 20px; width: 100%; max-width: 360px; margin-left: auto; margin-right: auto; overflow-x: hidden; }.gift-card { background: linear-gradient(135deg, #334155, #1e293b); padding: 6px; aspect-ratio: 1 / 1; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.4); transition: transform 0.2s ease; overflow: hidden; box-sizing: border-box; max-width: 100%; }.gift-card:hover {  transform: translateY(-3px);  box-shadow: 0 6px 12px rgba(0,0,0,0.5);}.gift-card-icon {  font-size: 2em;  color: #ffbf00;  margin-bottom: 8px;}.gift-card-amount {  font-size: 1em;  font-weight: bold;  color: #fff;  margin-bottom: 10px;}.gift-card-buy-btn {  background: #00a884;  color: #fff;  padding: 6px 14px;  border-radius: 20px;  font-size: 0.85em;  font-weight: bold;  cursor: pointer;  border: none;}.gift-card-buy-btn:hover {  background: #008f6b;}

    /* Styles for the Users List */
    #membersList, #friendsList {
        list-style: none;
        padding: 0;
        margin: 0;
        width: 100%;
        color: #fff;
    }
    #membersList li, #friendsList li {
        background: linear-gradient(135deg, #e0f7fa, #bbdefb) !important;
    color: #2563eb !important;
        padding: 12px 15px;
        margin-bottom: 5px;
        border-radius: 8px;
        text-align: left;
        font-size: 1.1em;
        font-weight: bold;
        display: flex;
        align-items: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        justify-content: space-between;
        cursor: pointer; /* Make list items clickable */
    }
    #membersList li:last-child, #friendsList li:last-child {
        margin-bottom: 0;
    }
    #membersList li .initial-circle, #friendsList li .initial-circle {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        background: linear-gradient(135deg, #e0f7fa, #bbdefb) !important;
    color: #2563eb !important;
        color: #0f172a;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 1.2em;
        font-weight: bolder;
        margin-right: 10px;
        flex-shrink: 0;
        position: relative;
    border: 2px solid #2563eb !important; background: transparent; }
    .user-actions {
        display: flex;
        gap: 8px;
    }
    .user-actions button {
        width: auto;
        padding: 8px 12px;
        margin: 0;
        font-size: 0.9em;
        border-radius: 20px;
    }
    .user-actions .chat-btn { background-color: #007bff; }
    .user-actions .chat-btn:hover { background-color: #0056b3; }
    .user-actions .send-btn { background-color: #22c55e; }
    .user-actions .send-btn:hover { background-color: #16a34a; }
    
    /* New Follow Button Style */
    .user-actions .follow-btn {
        background: linear-gradient(135deg, #4f46e5, #3b82f6) !important; /* Blue for Follow */
        color: #fff;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .user-actions .follow-btn:hover {
        background: linear-gradient(135deg, #4f46e5, #3b82f6) !important;
    }
    /* Removed the 'followed' class for list view, as 'Unfollow' will be on profile */
    /* .user-actions .follow-btn.followed {
        background: linear-gradient(135deg, #4f46e5, #3b82f6) !important; 
        pointer-events: none; 
    } */
    .user-actions .unfollow-btn { /* Style for Unfollow button in Friendlist - will be on profile page */
        background-color: #dc3545; /* Red for Unfollow */
        color: #fff;
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .user-actions .unfollow-btn:hover {
        background-color: #c82333;
    }

    /* Blue tick for verified users */
    .verified-badge {
  display: inline-block;
  width: 18px;
  height: 18px;
  background-color: #2563eb !important; /* Instagram blue */
  color: white;
  border-radius: 50%;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  line-height: 18px;
  margin-left: 6px;
  box-shadow: 0 0 4px rgba(0,0,0,0.2);
  font-family: Arial, sans-serif;
}
        color: #007bff; /* Blue color for the tick */
        font-size: 1.2em; /* Adjust size as needed */
        margin-left: 5px;
    }

    /* Chat specific styles */
    #messagesDisplay {
        height: 300px;
        overflow-y: scroll;
        border: 1px solid #334155;
        border-radius: 8px;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #1a2430;
        text-align: left;
    }
    #messagesDisplay p {
        margin: 5px 0;
        padding: 8px 12px;
        border-radius: 15px;
        max-width: 70%;
        word-wrap: break-word;
        font-size: 0.95em;
        position: relative;
    }
    .my-message {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        text-align: right;
    }
    .other-message {
        background-color: #334155;
        color: white;
        margin-right: auto;
        text-align: left;
    }
    .message-timestamp {
        font-size: 0.7em;
        color: #c0c0c0;
        margin-top: 2px;
        display: block;
    }

    /* Message Ticks */
    .message-tick {
        position: absolute;
        bottom: 5px;
        font-size: 0.8em;
    }
    .my-message .message-tick {
        right: 8px;
        color: #ddd;
    }
    .my-message .message-tick.seen {
        color: #00ff99;
    }

    /* Online/Offline Dot for User List */
    .initial-circle .online-dot {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 10px;
        height: 10px;
        background-color: #22c55e;
        border-radius: 50%;
        border: 2px solid #2a384e;
        display: block;
    }
    .initial-circle .offline-dot {
        position: absolute;
        bottom: -2px;
        right: -2px;
        width: 10px;
        height: 10px;
        background-color: #ef4444;
        border-radius: 50%;
        border: 2px solid #2a384e;
        display: block;
    }

    /* Customer Service Styling */
    #customerSupportMessage {
        width: calc(100% - 24px);
        min-height: 100px;
        margin-bottom: 15px;
        resize: vertical;
    }
    #customerServiceList {
        list-style: none;
        padding: 0;
        margin: 0;
        width: 100%;
        color: #fff;
    }
    .customer-service-item {
        background-color: #2a384e;
        padding: 12px 15px;
        margin-bottom: 8px;
        border-radius: 8px;
        text-align: left;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    .customer-service-item h4 {
        margin: 0 0 5px 0;
        color: #ffbf00;
        font-size: 1.1em;
    }
    .customer-service-item p {
        margin: 0;
        font-size: 0.9em;
        color: #cbd5e1;
    }
    .customer-service-item .timestamp {
        font-size: 0.75em;
        color: #94a3b8;
        text-align: right;
        margin-top: 5px;
    }
    #customerServiceReplyBox {
        margin-top: 15px;
        background-color: #1a2430;
        padding: 15px;
        border-radius: 50px;
    }
    #customerServiceReplyBox h4 {
        color: #fff;
        margin-top: 0;
    }
    #customerServiceReplyText {
        width: calc(100% - 24px);
        min-height: 80px;
        margin-bottom: 10px;
        resize: vertical;
    }
    .reply-message {
        background-color: #334155;
        color: #fff;
        padding: 8px 12px;
        border-radius: 50px;
        margin-top: 5px;
        font-size: 0.9em;
        text-align: left;
    }

    /* Profile Specific Styles */

.profile-header {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
}
.profile-initial-circle {
    width: 100px;
    height: 100px;
    font-size: 3em;
    margin-bottom: 10px;
}
.profile-username {
    font-size: 1.6em;
    font-weight: 600;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 6px;
}
.profile-username .verified-badge {
  display: inline-block;
  width: 18px;
  height: 18px;
  background-color: #3897f0; /* Instagram blue */
  color: white;
  border-radius: 50%;
  font-size: 14px;
  font-weight: bold;
  text-align: center;
  line-height: 18px;
  margin-left: 6px;
  box-shadow: 0 0 4px rgba(0,0,0,0.2);
  font-family: Arial, sans-serif;
}
.profile-stats {
    display: flex;
    justify-content: center;
    gap: 25px;
    margin: 12px 0 18px;
}
.profile-stat-item {
    text-align: center;
}
.profile-stat-number {
    font-size: 1.2em;
    font-weight: bold;
}
.profile-actions {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 15px;
    flex-wrap: wrap;
}
.profile-actions button {
    padding: 10px 16px;
    border-radius: 12px;
    font-size: 1em;
    min-width: 90px;
}

    .profile-header {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 60px;
    }
    .profile-initial-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background-color: #ffbf00;
        color: #0f172a;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 3em;
        font-weight: bolder;
        margin-bottom: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    /* Adjusted styles for bio to be larger */
    #profileBio, #otherProfileBio {
        font-size: 1.2em;
        background: linear-gradient(135deg, #1f2937, #334155);
        border: 1px solid #ffbf00;
        padding: 20px;
        box-shadow: 0 0 10px rgba(0,0,0,0.5);
        background-color: #2a384e;
        color: #fff;
        padding: 15px;
        border-radius: 50px;
        text-align: left;
        min-height: 120px; /* Increased min-height for bio */
        margin-bottom: 15px;
        resize: vertical;
        width: calc(100% - 24px);
        font-size: 1.1em; /* Slightly larger text for readability */
        line-height: 1.5;
    }
    #profileBio.editable {
        border: 1px solid #ffbf00;
    }
    #profileBio.editable:focus {
        outline: none;
        box-shadow: 0 0 0 2px #ffbf00;
    }
    #saveBioBtn {
        background-color: #22c55e;
    }
    #saveBioBtn:hover {
        background-color: #16a34a;
    }
    .profile-actions {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }
    .profile-actions button {
        width: auto;
        max-width: 150px;
    }
    .profile-actions .follow-btn {
        background-color: #007bff;
    }
    .profile-actions .follow-btn:hover {
        background-color: #0056b3;
    }
    .profile-actions .unfollow-btn {
        background-color: #dc3545;
    }
    .profile-actions .unfollow-btn:hover {
        background-color: #c82333;
    }

    /* Note for emoji profile pictures */
    .profile-picture-note {
        font-size: 0.85em;
        color: #94a3b8;
        margin-top: 5px;
    }

    /* Chat message reaction styles */
    .message-reactions {
        display: flex;
        gap: 5px;
        margin-top: 5px;
        font-size: 0.9em;
        position: relative; /* For positioning reactions on messages */
    }
    .message-reactions .reaction-item {
        background-color: rgba(0,0,0,0.2);
        padding: 2px 7px;
        border-radius: 50px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .message-reactions .reaction-item:hover {
        background-color: rgba(0,0,0,0.4);
    }
    .message-reactions .reaction-item.reacted-by-me {
        background-color: #4CAF50; /* Highlight if I reacted */
        color: white;
    }
    /* Reaction button on individual message */
    .react-button {
        background: none;
        border: none;
        color: #ffbf00; /* Yellowish color for reaction icon */
        font-size: 1.2em;
        cursor: pointer;
        padding: 0 5px;
        margin-left: 5px;
        transition: transform 0.1s ease;
    }
    .react-button:hover {
        transform: scale(1.1);
    }
    .other-message .react-button {
        float: right; /* To position reaction button on right for other's messages */
    }
    .my-message .react-button {
        float: left; /* To position reaction button on left for my messages */
    }
    /* Chat Content Picker Styles (Emojis, Stickers, Gifts) */
    #chatContentPicker {
        display: none; /* Hidden by default */
        position: absolute;
        bottom: 60px; /* Adjust based on your layout to appear above input */
        left: 50%;
        transform: translateX(-50%);
        background-color: #2a384e;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        padding: 10px;
        z-index: 99;
        width: 90%;
        max-width: 300px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
        gap: 5px;
        max-height: 200px;
        overflow-y: auto;
    }
    #chatContentPicker button {
        width: 30px;
        height: 30px;
        padding: 0;
        margin: 0;
        font-size: 1.2em;
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.1s ease;
    }
    #chatContentPicker button:hover {
        background-color: #334155;
    }
    #chatInputContainer {
        display: flex;
        align-items: center;
        gap: 5px;
        width: 100%; /* Ensure it spans the full width of its parent */
        max-width: 450px; /* Matches parent section max-width */
        margin: 0 auto; /* Center it */
        position: relative; /* For positioning the picker above it */
    }
    #chatInputContainer input {
        flex-grow: 1; /* Allow input to take available space */
        margin: 0; /* Remove default input margins */
    }
    #chatInputContainer button {
        margin: 0;
        width: auto;
        padding: 12px;
        border-radius: 50px;
    }
    #emojiButton, #stickerGiftButton {
        background: #334155;
        color: #ffbf00;
        font-size: 20px;
        padding: 12px;
        border-radius: 50px;
        cursor: pointer;
    }

    /* Custom Sticker Styles */
    .sticker-item {
        background-color: #4a5b70; /* Default sticker background */
        color: #fff;
        border-radius: 8px;
        font-size: 1.5em; /* Larger for stickers */
        padding: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px; /* Make stickers a bit larger */
        height: 40px;
        cursor: pointer;
        transition: transform 0.1s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .sticker-item:hover {
        transform: scale(1.1);
    }
    .sticker-yellow { background-color: #fdd835; color: #333; }
    .sticker-blue { background-color: #42a5f5; }
    .sticker-green { background-color: #66bb6a; }
    .sticker-red { background-color: #ef5350; }
    .sticker-purple { background-color: #ab47bc; }

    /* Gift Item Styles */
    .gift-item {
        background-color: #00a884; /* Gift specific background */
        color: #fff;
        border-radius: 8px;
        font-size: 1.8em; /* Larger for gifts */
        padding: 5px;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 40px;
        height: 40px;
        cursor: pointer;
        transition: transform 0.1s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .gift-item:hover {
        transform: scale(1.1);
    }

    /* Mailbox Section Specific Styles */
    #mailboxSection h3 {
        color: #ffbf00;
        margin-bottom: 60px;
    }
    #mailboxDisplay {
        background-color: #1a2430;
        border-radius: 50px;
        padding: 15px;
        margin-bottom: 15px;
        text-align: left;
        max-height: 400px;
        overflow-y: auto;
    }
    .mailbox-message-item {
        background-color: #2a384e;
        padding: 12px 15px;
        margin-bottom: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        color: #fff;
    }
    .mailbox-message-item h4 {
        margin: 0 0 5px 0;
        color: #ffbf00;
        font-size: 1.1em;
    }
    .mailbox-message-item p {
        margin: 0;
        font-size: 0.9em;
        color: #cbd5e1;
    }
    .mailbox-message-item .timestamp {
        font-size: 0.75em;
        color: #94a3b8;
        text-align: right;
        margin-top: 5px;
    }
    /* No messages text */
    #mailboxDisplay p.no-messages {
        text-align: center;
        color: #cbd5e1;
        padding: 20px;
    }

  
/* Improved button styling */
button {
  background: linear-gradient(135deg, #4f46e5, #3b82f6);
  color: white !important;
  font-weight: 600;
  padding: 10px 20px;
  border-radius: 12px;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
button:hover {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  transform: translateY(-2px);
}
button:active {
  transform: scale(0.98);
}
input, textarea {
  border: 1px solid #94a3b8;
  padding: 10px;
  border-radius: 50px;
  margin: 5px 0;
  width: 90%;
  max-width: 320px;
}
.section {
  padding: 15px;
  margin: 15px auto;
  border-radius: 15px;
  background-color: #1e293b;
  width: 95%;
  max-width: 450px;
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

.jio-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #ff0000;
  color: white;
  font-weight: bold;
  font-size: 18px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
}
  
#membersList li, #friendsList li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 15px;
    border-radius: 15px;
    background: linear-gradient(135deg, #e0f7fa, #bbdefb) !important;
    color: #2563eb !important;
    font-weight: bold;
}
#membersList li .user-info, #friendsList li .user-info {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-grow: 1;
}
#membersList li .initial-circle, #friendsList li .initial-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, #e0f7fa, #bbdefb) !important;
    color: #2563eb !important;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.2em;
    font-weight: bold;
    flex-shrink: 0;
border: 2px solid #2563eb !important; background: transparent; }
#membersList li .username-text, #friendsList li .username-text {
    font-size: 1.1em;
    font-weight: bold;
    display: flex;
    align-items: center;
    gap: 5px;
}
#membersList li .verified-badge, #friendsList li .verified-badge {
    flex-shrink: 0;
}
.user-actions {
    display: flex;
    gap: 6px;
    flex-shrink: 0;
}

.profile-username, 
.profile-stat-number, 
.profile-stat-label, 
.profile-stat-item i {
    color: #6c88d1 !important;
}

/* --- News Section Channel Style --- */
#newsSection {
    background: #ffffff !important;
    color: #000000 !important;
    font-weight: bold;
    margin: 10px auto;
    padding: 15px 20px;
    border-radius: 15px;
    max-width: 500px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    display: block;
    text-align: left;
    border-left: 6px solid #d32f2f; /* Red news channel accent */
}
#newsSection .news-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 10px;
}
#newsSection .news-header span.title {
    font-size: 1.6em;
    font-weight: 800;
    color: #d32f2f;
    font-family: 'Arial Black', sans-serif;
}
#newsSection .news-item {
    margin-bottom: 12px;
}
#newsSection .news-item h4 {
    font-size: 1.2em;
    margin: 0 0 4px;
    color: #000;
}
#newsSection .news-item .news-date {
    display: inline-block;
    background: #d32f2f;
    color: #fff;
    padding: 3px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}
#newsSection .news-item p {
    font-size: 1em;
    color: #333;
    margin: 4px 0 0;
}
</style>
<style>
   #messagesDisplay p {
    margin: 6px 0;
    padding: 10px 15px;
    border-radius: 20px;
    font-size: 0.95em;
    max-width: 80%;
    word-break: break-word;
    position: relative;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  }
  .my-message {
    background-color: #0088ff;
    color: #fff;
    margin-left: auto;
    text-align: right;
    border-bottom-right-radius: 4px;
  }
  .other-message {
    background-color: #2e3a4e;
    color: #fff;
    margin-right: auto;
    text-align: left;
    border-bottom-left-radius: 4px;
  }
  .message-timestamp {
    font-size: 0.7em;
    color: #94a3b8;
    margin-top: 3px;
    display: block;
  }

.jio-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #ff0000;
  color: white;
  font-weight: bold;
  font-size: 18px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
}
  </style>
<style>
   @keyframes pulseDot {
    0% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.3); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
  }
  #mailboxDot.animated {
    animation: pulseDot 1s infinite;
  }

.jio-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #ff0000;
  color: white;
  font-weight: bold;
  font-size: 18px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
}
  </style>
<!-- Chatbot Integration -->
<script>
   // Function to load Q&A from Firebase for the chatbot
  function loadChatbotQA() {
    const userQuestion = document.getElementById("chatbotQuestion").value.trim();
    if (!userQuestion) return alert("Please enter a question.");

    const chatbotResponseDisplay = document.getElementById("chatbotResponse");

    // Firebase reference for chatbot Q&A
    const dbRef = firebase.database().ref("chatbotQA");
    dbRef.once("value", (snapshot) => {
      const qaData = snapshot.val();
      let response = "Sorry, I don't know the answer to that question.";
      // Loop through stored Q&A and find a matching question
      for (let key in qaData) {
        if (qaData[key].question.toLowerCase() === userQuestion.toLowerCase()) {
          response = qaData[key].answer;
          break;
        }
      }
      // Display response from chatbot
      chatbotResponseDisplay.innerHTML = response;
    });
  }

  // Function for owner to add new questions and answers
  function addQA() {
    const question = document.getElementById("ownerQuestion").value.trim();
    const answer = document.getElementById("ownerAnswer").value.trim();
    if (!question || !answer) return alert("Please fill in both question and answer.");

    const qaData = { question, answer };

    // Push new Q&A to Firebase
    const newRef = firebase.database().ref("chatbotQA").push();
    newRef.set(qaData)
      .then(() => alert("New Q&A added successfully!"))
      .catch(error => alert("Error adding Q&A: " + error.message));
  }
  </script>
<script>
   function setBulkMessage() {
  const msg = document.getElementById("bulkMsgInput").value.trim();
  if (!msg) return alert("Please write a message first!");
  firebase.database().ref("bulkDashboardMsg").set(msg)
    .then(() => alert("üì¢ Message updated for all dashboards!"))
    .catch(e => alert("‚ùå Failed: " + e.message));
}

function showBulkMessageOnDashboard() {
  const target = document.getElementById("bulkDashboardMessage");
  if (!target) return;
  db.ref("bulkDashboardMsg").on("value", snap => {
    if (!snap.exists()) return target.innerHTML = "";
    if (!snap.val().trim()) { target.style.display = "none"; return; } target.innerHTML = `üì¢ <b>Note:</b> ${snap.val()}`; target.style.display = "block";
  });
}
  </script>
<style>
/* ASMR Theme for Tweet Section */
#tweetSection {
    background: linear-gradient(135deg, #fce4ec, #e0f7fa);
    border-radius: 25px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 20px !important;
    transition: all 0.4s ease-in-out;
}
#tweetSection:hover {
    transform: scale(1.01);
    box-shadow: 0 6px 24px rgba(0,0,0,0.15);
}
#tweetSection h3 {
    color: #ff80ab !important;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    text-shadow: 0 0 6px rgba(255,128,171,0.4);
}
#tweetSection textarea {
    background: rgba(255,255,255,0.8);
    border-radius: 15px;
    border: 1px solid #f8bbd0;
    padding: 12px;
    font-size: 1em;
    color: #444;
    box-shadow: inset 0 2px 6px rgba(0,0,0,0.05);
    transition: border 0.3s ease;
}
#tweetSection textarea:focus {
    border: 1px solid #ff80ab;
    outline: none;
    box-shadow: 0 0 8px rgba(255,128,171,0.3);
}
#tweetsFeed {
    background: linear-gradient(135deg, #e0f7fa, #fce4ec);
    border-radius: 25px !important;
    box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    padding: 20px !important;
}
#tweetsFeed h3 {
    color: #80deea !important;
    font-family: 'Comic Sans MS', cursive, sans-serif;
    text-shadow: 0 0 6px rgba(128,222,234,0.4);
}
#tweetsList .tweet-item {
    background: rgba(255,255,255,0.8);
    border-radius: 15px;
    padding: 12px;
    margin-bottom: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
}
#tweetsList .tweet-item:hover {
    transform: translateY(-2px);
}
</style>
<style>
/* ASMR Theme for individual tweets */
#tweetsList .tweet-item {
    background: #ffd6e8; /* Softer pastel pink */
    border-radius: 25px; /* Rounded corners */
    padding: 15px;
    margin: 12px 10px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-family: 'Segoe UI', sans-serif;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
}
#tweetsList .tweet-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 14px rgba(0,0,0,0.12);
}
#tweetsList .tweet-header {
    display: flex;
    justify-content: space-between;
    font-weight: bold;
    font-size: 1em;
    color: #c2185b; /* Rose pink */
}
#tweetsList .tweet-text {
    font-size: 0.95em;
    color: #333;
    white-space: pre-wrap;
}
#tweetsList .tweet-time {
    background: #ffd6e8; /* Match pastel background for date */
    font-size: 0.8em;
    color: #666;
    text-align: right;
}
</style>
</head>
<body>
<!-- Chatbot & Q&A Content (Initially hidden) -->
<div id="chatbotContent" style="display: none; position: fixed; right: 10px; bottom: 100px; background: #2a384e; width: 300px; padding: 20px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
<!-- Chatbot -->
<div style="margin-top:20px;"></div><h3 style="color: #ffbf00;">
    Chat with Chatbot
   </h3>
<input id="chatbotQuestion" placeholder="Ask a question..." style="width: 100%; padding: 10px; border-radius: 50px; margin-bottom: 10px;" type="text"/>
<button onclick="loadChatbotQA()" style="background-color: #ffbf00; color: #000; padding: 10px 20px; border-radius: 50px; cursor: pointer;">
    Ask
   </button>
<p id="chatbotResponse" style="color: #fff; margin-top: 15px;">
</p>
<button onclick="hideChatbotAndGoBack()" style="margin-top: 15px; background-color: #6c88d1; color: #fff; padding: 10px 20px; border-radius: 50px; cursor: pointer;">
    ‚¨Ö Back to Dashboard
   </button>
<!-- Q&A Management for Owner -->
<div style="margin-top:20px;"></div><h3 style="color: #ffbf00;">
    Owner Panel - Manage Q&amp;A
   </h3>
</div>
<!-- Owner Panel for Managing Chatbot Q&A -->
<!-- Removed duplicate body tag -->
<div style="background: transparent; box-shadow: none;">
<h1>
    ‚ö° THUNDERXPAY
   </h1>
<div id="chooser">
<button onclick="showScreen('signup')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     üìù Sign Up
    </button>
<button onclick="showScreen('login')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     üîê Log In
    </button>
</div>
<div class="hidden" id="signup">
<input id="sUser" placeholder="Username"/>
<input id="sPass" placeholder="Password" type="password"/>
<button onclick="signup()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     Create Account
    </button>
<button onclick="showScreen('chooser')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     ‚¨Ö Back
    </button>
</div>
<div class="hidden" id="login">
<input id="lUser" placeholder="Username"/>
<input id="lPass" placeholder="Password" type="password"/>
<button onclick="login()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     Log In
    </button>
<button onclick="showScreen('chooser')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     ‚¨Ö Back
    </button>
</div>
<div class="hidden" id="dash">
<button id="settings" onclick="toggleSettings()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     ‚öôÔ∏è
    </button>
<div id="settingsMenu">
<button onclick="showSub('myProfileSection')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      üë§ My Profile
     </button>
<button onclick="showSub('changePwd')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      üîë Change Password
     </button>
<button onclick="showSub('customerSupportSection')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚ùì Customer Support
     </button>
<button onclick="window.open('https://whatsapp.com/channel/0029VbAujRR47Xe3cl50sZ0J', '_blank')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      üí¨ WhatsApp Channel
     </button>
<button onclick="logout()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      üö™ Log Out
     </button>
</div>
<button id="notificationBell" onclick="handleBellClick()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     üîî
     <span class="dot hidden" id="notificationDot">
</span>
</button>
<button class="hidden" id="profileIconBtn" onclick="showSub('myProfileSection')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
     üë§
    </button>
<div id="dashboardMainContent"><div id="homeTab" style="display:block; padding-bottom:60px;"><div id="bulkDashboardMessage" style="background:#1e293b; color:#ffbf00; font-weight:bold; margin:10px auto; padding:15px 20px; border-radius:15px; max-width:450px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display:block;">
</div><div id="specialGiftArea">
</div><h2>Welcome, <span id="uname"></span></h2><div id="newsSection"><div class="news-header"><span style="font-size:1.5em;">üéôÔ∏è</span><span class="title">THUNDER TODAY</span></div><div class="news-item" id="newsContent">No news available.</div></div>
</div><script>document.addEventListener('DOMContentLoaded', showBulkMessageOnDashboard);</script><div id="exploreTab" style="display:none; padding-bottom:60px;">
<div id="tweetSection" style="display:none;margin:0;padding:0;"><style>display:none;</style>
<h3 style="color:#ffbf00;">üìù Post a Tweet</h3>
<textarea id="tweetInput" placeholder="What's happening?" style="width:90%; padding:10px; border-radius:10px; min-height:60px;"></textarea>
<br/>
<button onclick="postTweet()" style="margin-top:8px; background-color:#22c55e;">Tweet</button>
</div>
<div id="tweetsFeed" style="display:none;margin:0;padding:0;"><style>display:none;</style>
<h3 style="color:#ffbf00;">üì¢ Recent Tweets</h3>
<div id="tweetsList" style="text-align:left;"></div>
</div>
</div><div id="payTab" style="display:none; padding-bottom:60px;">
<h2>üí∞ Balance: ‚Çπ <span id="bal"></span></h2><div style="margin-top: 20px; background: #ffffff; padding: 15px; border-radius: 50px; color: #000;">
<div style="margin-top:20px;"></div><h3 style="color: #ffbf00;">
       üéØ Available Special Gift Codes
      </h3>
<div id="specialCodesList" style="color:#000; font-size: 0.95em; margin-top: 10px;">
<a href="https://t.me/thunderxpay" style="color:#007bff; font-weight:bold; text-decoration:none;" target="_blank">
        Join our Telegram
       </a>
</div>
<button onclick="applySpecialCode()" style="margin-top:10px; background-color: #22c55e;">
       üéÅ Apply Special Code
      </button>
</div><div style="margin-top:150px;"></div><button onclick="showSub('send')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none; margin: 5px; flex: 1 1 45%; max-width: 200px; padding: 10px 14px !important; font-size: 0.85em !important; margin: 15px 5px !important; flex: 1 1 45% !important; max-width: 160px !important;; font-weight: 800; margin-top: 10px">
       üí∏ Send Money
      </button><button onclick="showSub('gift')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none; margin: 5px; flex: 1 1 45%; max-width: 200px; padding: 10px 14px !important; font-size: 0.85em !important; margin: 15px 5px !important; flex: 1 1 45% !important; max-width: 160px !important;; font-weight: 800; margin-top: 10px">
       üéÅ Gift Store
      </button><button onclick="showSub('receive')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none; margin: 5px; flex: 1 1 45%; max-width: 200px; padding: 10px 14px !important; font-size: 0.85em !important; margin: 15px 5px !important; flex: 1 1 45% !important; max-width: 160px !important;; font-weight: 800; margin-top: 10px">
       üì• Receive
      </button><button id="mailboxBtn" onclick="showSub('mailboxSection')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none; margin: 5px; flex: 1 1 45%; max-width: 200px; padding: 10px 14px !important; font-size: 0.85em !important; margin: 15px 5px !important; flex: 1 1 45% !important; max-width: 160px !important;; font-weight: 800; margin-top: 10px">
       ‚úâÔ∏è Mailbox
       <span class="dot hidden" id="mailboxDot">
</span>
<span id="giftIcon" style="display:none;">
        üéÅ
       </span>
</button><button onclick="showSub('history')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none; margin: 5px; flex: 1 1 45%; max-width: 200px; padding: 10px 14px !important; font-size: 0.85em !important; margin: 15px 5px !important; flex: 1 1 45% !important; max-width: 160px !important;; font-weight: 800; margin-top: 10px">üìú History</button>
<button onclick="toggleChatbot()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none; margin: 5px; flex: 1 1 45%; max-width: 200px; padding: 10px 14px !important; font-size: 0.85em !important; margin: 15px 5px !important; flex: 1 1 45% !important; max-width: 160px !important;; font-weight: 800; margin-top: 10px">
       ü§ñ Chatbot
      </button></div>
<div id="bottomNav" style="display:none; position:fixed; bottom:0; left:0; width:100%; background:#1e293b; border-top:1px solid #334155; display:flex; justify-content:space-around; padding:8px 0; z-index:999;">
<button onclick="switchTab('homeTab')" style="background:none; border:none; color:#fff; text-align:center; flex:1; color: #fff !important; background-color: #00008B !important;">
            üè†<div style="font-size:0.8em;">Home</div>
</button>
<button onclick="switchTab('exploreTab')" style="background:none; border:none; color:#fff; text-align:center; flex:1; color: #fff !important; background-color: #00008B !important;">
            üîç<div style="font-size:0.8em;">Explore</div>
</button>
<button onclick="switchTab('payTab')" style="background:none; border:none; color:#fff; text-align:center; flex:1; color: #fff !important; background-color: #00008B !important;">
            üí≥<div style="font-size:0.8em;">Pay</div>
</button>
</div>
</div>
<div class="section" id="send">
<h3>
      Send Money
     </h3>
<input id="rec" placeholder="Recipient Username"/>
<input id="amt" placeholder="Amount" type="number"/>
<button onclick="sendMoney()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      Send
     </button>
<div class="loader hidden" id="anim">
</div>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
<div class="section" id="gift">
<h3>
      Gift Card Store
     </h3>
<div id="giftResult" style="margin-top:10px;">
</div>
<div class="gift-card-container">
<div class="gift-card" onclick="purchaseGift(10)">
<span class="gift-card-icon">
        üéÅ
       </span>
<div class="gift-card-amount">
        ‚Çπ10 Gift Card
       </div>
<button class="gift-card-buy-btn" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Buy Now
       </button>
</div>
<div class="gift-card" onclick="purchaseGift(20)">
<span class="gift-card-icon">
        üåü
       </span>
<div class="gift-card-amount">
        ‚Çπ20 Gift Card
       </div>
<button class="gift-card-buy-btn" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Buy Now
       </button>
</div>
<div class="gift-card" onclick="purchaseRecharge('Jio ‚Çπ11', 11)">
<div class="jio-icon">
        Jio
       </div>
<div class="gift-card-amount">
        ‚Çπ11 Jio
       </div>
<div style="color:#94a3b8; font-size: 0.9em; margin-top: 4px;">
        10 GB ‚Ä¢ 1 Hour
       </div>
<button class="gift-card-buy-btn">
        Recharge
       </button>
</div>
<div class="gift-card" onclick="purchaseRecharge('Jio ‚Çπ19', 19)">
<div class="jio-icon">
        Jio
       </div>
<div class="gift-card-amount">
        ‚Çπ19 Jio
       </div>
<div style="color:#94a3b8; font-size: 0.9em; margin-top: 4px;">
        1 GB ‚Ä¢ 1 Day
       </div>
<button class="gift-card-buy-btn">
        Recharge
       </button>
</div>
<div class="gift-card" onclick="purchaseRecharge('Jio ‚Çπ299', 299)">
<div class="jio-icon">
        Jio
       </div>
<div class="gift-card-amount">
        ‚Çπ299 Jio
       </div>
<div style="color:#94a3b8; font-size: 0.9em; margin-top: 4px;">
        1.5 GB/Day ‚Ä¢ 28 Days
       </div>
<button class="gift-card-buy-btn">
        Recharge
       </button>
</div>
<div class="gift-card" onclick="purchaseRecharge('Jio ‚Çπ349', 349)">
<div class="jio-icon">
        Jio
       </div>
<div class="gift-card-amount">
        ‚Çπ349 Jio
       </div>
<div style="color:#94a3b8; font-size: 0.9em; margin-top: 4px;">
        2 GB/Day ‚Ä¢ 28 Days
       </div>
<button class="gift-card-buy-btn">
        Recharge
       </button>
</div>
</div>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
<div class="section" id="receive">
<h3>
      Your Receive Code
     </h3>
<p id="receiveCode" style="color: #d1d9f5;">
</p>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
<div class="section" id="history">
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
<div class="tab-container">
<button class="tab-button active" onclick="switchHistoryTab('transactionsHist', this)" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Transactions
      </button>
<button class="tab-button" onclick="switchHistoryTab('purchaseHist', this)" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Purchase History
      </button>
</div>
<div class="history-tab-content" id="transactionsHist">
<h3>
       Transactions
      </h3>
<ul id="transactionList">
</ul>
</div>
<div class="history-tab-content hidden" id="purchaseHist">
<h3>
       Purchase History
      </h3>
<ul id="purchaseList">
</ul>
</div>
</div>
<div class="section" id="changePwd">
<h3>
      Change Password
     </h3>
<input id="newPass" placeholder="New Password" type="password"/>
<button onclick="changePassword()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      Update
     </button>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
<div class="section" id="customerSupportSection">
<h3>
      Customer Support
     </h3>
<textarea id="customerSupportMessage" placeholder="Write your issue here..."></textarea>
<button onclick="submitCustomerSupportMessage()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      Send Message
     </button>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
<div class="section" id="owner">
<h3>
      Owner Panel
     </h3>
<input id="pin" placeholder="Enter PIN" type="password"/>
<div id="ownerOrdersButton" style="display: none; margin-top: 10px;">
<button onclick="showSub('rechargeOrdersSection'); loadRechargeOrders()" style="background-color: #ffbf00; color: #000; font-weight: bold; 
    border-radius: 50px; padding: 12px 18px; border: none;">
    üîå New Orders
  </button>
</div>
<script>
  function showOwnerOrdersButton() {
    const btn = document.getElementById("ownerOrdersButton");
    if (btn) btn.style.display = "block";
  }
</script>
<button onclick="showSub('rechargeOrdersSection'); loadRechargeOrders()" style="margin-top: 10px; background-color: #ffbf00; color: #000; font-weight: bold; border-radius: 50px; padding: 12px 18px; border: none;">üîå New Orders</button>
<button onclick="authOwner()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      Unlock
     </button>
<div class="hidden" id="ownerBox">
<div style="margin-top: 20px;">
<button onclick="toggleOwnerSection('ownerAddCode')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        ‚ûï Add Gift Code
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerAddMoney')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        üí∞ Add Money to User
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerSetMessage')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        üì¢ Set Owner Message
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerVerify')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        ‚úîÔ∏è Toggle Verified Badge
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerSendReward')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        üéÅ Send Reward to Mailbox
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerAnalytics')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        üìä User Analytics
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerSpecialGiftCode')" style="background-color: #6c88d1; color: #fff; font-weight: bold; border-radius: 50px; padding: 12px 18px; border: none;">
        üéØ Special Code
       </button>
<br/>
<button onclick="toggleOwnerSection('ownerBulkMsg')" style="background-color: #6c88d1; color: #fff; font-weight: bold; border-radius: 50px; padding: 12px 18px; border: none;">
        üì¢ Bulk Dashboard Msg
       </button>
<div class="hidden" id="ownerBulkMsg" style="margin-top:15px;">
<input id="bulkMsgInput" placeholder="Write dashboard message here"/>
<button onclick="setBulkMessage()" style="background-color: #6c88d1; color: #fff; font-weight: bold; border-radius: 50px; padding: 12px 18px; border: none;">
         Set Bulk Dashboard Msg
        </button>
</div>
<button onclick="toggleOwnerSection('ownerSupport')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        ‚ùì Customer Service
       </button>
<br/>
</div>
<div class="hidden" id="ownerAddCode" style="margin-top:15px;">
<input id="newCode" placeholder="Add Gift Code"/>
<input id="newCodeAmt" placeholder="Amount (10/20)" type="number"/>
<button onclick="addCode()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Add
       </button>
<p id="ownerMsg" style="color: #d1d9f5;">
</p>
</div>
<div class="hidden" id="ownerAddMoney" style="margin-top:15px;">
<input id="addUser" placeholder="Username"/>
<input id="addAmt" placeholder="Amount" type="number"/>
<button onclick="addMoney()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Add Money
       </button>
</div>
<div class="hidden" id="ownerSetMessage" style="margin-top:15px;">
<input id="ownerMessageInput" placeholder="Message for Users"/>
<button onclick="setOwnerMessage()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Set Message
       </button>
</div>
<div class="hidden" id="ownerVerify" style="margin-top:15px;">
<input id="verifiedUserToggleInput" placeholder="Username"/>
<button onclick="toggleVerifiedStatus()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Toggle Verified
       </button>
<p id="verifiedStatusMsg" style="color: #d1d9f5;">
</p>
</div>
<div class="hidden" id="ownerSendReward" style="margin-top:15px;">
<input id="rewardUser" placeholder="Recipient Username"/>
<input id="rewardAmount" placeholder="Amount or Gift Card" type="number"/>
<input id="rewardMessage" placeholder="Message for Reward"/>
<button onclick="sendReward()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        Send Reward
       </button>
</div>
<div class="hidden" id="ownerAnalytics" style="margin-top:15px;">
<button onclick="loadUserAnalytics()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
        üîÑ Refresh Analytics
       </button>
<div id="analyticsResults" style="margin-top:10px; text-align:left; background:#1e293b; padding:15px; border-radius:10px; color:#fff; font-size:0.9em;">
</div>
<!-- ‚úÖ New Band Creator Category (within User Analytics) -->
<div id="bandCreatorSection" style="margin-top:25px;">
<h4 style="color:#ffbf00;">
         üö´ Band Creator
        </h4>
<p style="color: #d1d9f5;">
         Owner can view all users and ban or delete their account.
        </p>
<button onclick="loadBandCreatorUsers()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
         üîÑ Load ThunderPay Users
        </button>
<div id="bandCreatorUserList" style="margin-top:15px;">
</div>
</div>
<script>
        function loadBandCreatorUsers() {
  const container = document.getElementById("bandCreatorUserList");
  container.innerHTML = "<p style='color:white;'>Loading users...</p>";

  db.ref("thunderPayUsers").once("value", snap => {
    if (!snap.exists()) {
      container.innerHTML = "<p style='color:white;'>No users found.</p>";
      return;
    }

    const all = snap.val();
    let html = "<ul style='list-style:none; padding-left:0;'>";
    Object.entries(all).forEach(([username, data]) => {
      html += `
        <li style='margin-bottom:10px;'>
          <b style='color:#fff;'>${username}</b>
          <button onclick="banUser('${username}')" style='margin-left:10px;'>üö´ Ban</button>
          <button onclick="deleteUser('${username}')" style='margin-left:5px;'>üóëÔ∏è Delete</button>
        </li>
      `;
    });
    html += "</ul>";
    container.innerHTML = html;
  });
}

function banUser(username) {
  if (!confirm("Ban " + username + "?")) return;
  db.ref("thunderPayUsers/" + username + "/banned").set(true).then(() => {
    alert(username + " has been banned.");
  });
}

function deleteUser(username) {
  if (!confirm("Delete " + username + "?")) return;
  db.ref("thunderPayUsers/" + username).remove().then(() => {
    alert(username + " has been deleted.");
    loadBandCreatorUsers();
  });
}
       </script>
</div>
<br/>
<button onclick="addBulkSpecialCodes()" style="background-color: #22c55e; color: #fff; font-weight: bold; border-radius: 50px; padding: 12px 18px; border: none;">
       ‚ûï Add ‚Çπ5 Bulk Special Codes
      </button>
<div style="margin-top:15px; background:#1e293b; padding:10px; border-radius:10px;">
<h4 style="color:#ffbf00;">
        üß© Add Custom Bulk Codes
       </h4>
<input id="bulkCodeAmount" placeholder="Enter Amount (‚Çπ)" style="margin-bottom:8px;" type="number"/>
<textarea id="bulkCodeList" placeholder="Enter codes separated by comma or newline" style="width:90%; height:80px;"></textarea>
<br/>
<button onclick="addCustomBulkCodes()" style="background-color: #22c55e; color: #fff; font-weight: bold; border-radius: 50px; padding: 10px 18px; border: none;">
        ‚ûï Add Bulk Codes
       </button>
</div>
<div class="hidden" id="ownerSpecialGiftCode" style="margin-top:15px;">
<input id="specialGiftCodeInput" placeholder="Enter Special Code"/>
<input id="specialGiftAmountInput" placeholder="Amount" type="number"/>
<button onclick="addSpecialCode()">
        Add Special Code
       </button>
<button onclick="applySpecialCode()">
        Apply Code (for test)
       </button>
<input id="specialGiftCodeInput" placeholder="Enter Special Gift Code"/>
<input id="specialGiftMessage" placeholder="Message for Users"/>
<button onclick="broadcastGiftCode()" style="background-color: #6c88d1; color: #fff; font-weight: bold; border-radius: 50px; padding: 12px 18px; border: none;">
        üéØ Broadcast Gift Code
       </button>
</div>
<div class="hidden" id="ownerSupport" style="margin-top:15px;">
<ul id="customerServiceList">
</ul>
<div class="hidden" id="customerServiceReplyBox">
<h4 id="replyToUser">
</h4>
<div id="existingReplies">
</div>
<textarea id="customerServiceReplyText" placeholder="Write reply..."></textarea>
<button onclick="sendCustomerServiceReply()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
         Send Reply
        </button>
<button onclick="hideCustomerServiceReplyBox()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
         Close
        </button>
</div>
</div>
</div>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
<div class="section" id="latestNewsSection" style="background:#1e293b; padding:15px; border-radius:15px; margin-top:15px;">
<h3 style="color:#ffbf00;">üì∞ Post Latest News</h3>
<input id="newsTitle" placeholder="News Title" style="margin-bottom:10px;"/>
<textarea id="newsContent" placeholder="Write news details..." style="min-height:80px; margin-bottom:10px;"></textarea>
<button onclick="postLatestNews()">üì¢ Post News</button>
</div>
<script>
    function postLatestNews(){
        const title = document.getElementById("newsTitle").value.trim();
        const content = document.getElementById("newsContent").value.trim();
        if(!title || !content) return alert("Please fill all fields!");
        const now = new Date().toLocaleString('en-IN', {
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', hour12: false
        }).replace(',', '');
        const newsData = { title, content, time: now };
        firebase.database().ref("latestNews").push(newsData)
        .then(()=>{
            alert("‚úÖ News posted successfully!");
            document.getElementById("newsTitle").value = "";
            document.getElementById("newsContent").value = "";
        })
        .catch(e=>alert("‚ùå Failed: " + e.message));
    }
    </script>
<button onclick="addNews()">üì∞ Add News</button></div>
<div class="section" id="userListSection">
<div class="tab-container">
<button class="tab-button active" onclick="switchUserListTab('membersListContainer', this)" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Members List
      </button>
<button class="tab-button" onclick="switchUserListTab('friendsListContainer', this)" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Friendlist
      </button>
</div>
<input id="userSearchInput" onkeyup="filterUserList()" placeholder="Search User..." style="margin-top: 10px;" type="text"/>
<div class="user-list-tab-content" id="membersListContainer">
<h3>
       All THUNDERXPAY Users
      </h3>
<ul id="membersList">
</ul>
</div>
<div class="user-list-tab-content hidden" id="friendsListContainer">
<h3>
       Your Friendlist
      </h3>
<ul id="friendsList">
</ul>
</div>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Users
     </button>
</div>
<div class="section" id="chatSection">
<h3 id="chatPartnerName">
</h3>
<h1>
      ‚ú® ASMR Chat Theme ‚ú®
     </h1>
<div id="messagesDisplay">
</div>
<div id="typingIndicator" style="font-style: italic; color: #cbd5e1; margin-top: 5px; display: none;">
      Typing...
     </div>
<div id="chatInputContainer">
<input id="chatInput" onkeyup="handleTyping(event)" placeholder="Type your message..."/>
<button onclick="sendMessage()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Send
      </button>
</div>
<div class="hidden" id="chatContentPicker">
</div>
<button onclick="backToUserList()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Users
     </button>
</div>
<div class="section" id="myProfileSection" style="background-color: #e0efff; padding: 20px; border-radius: 15px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);">
<h3>
      My Profile
     </h3>
<div class="profile-header">
<div class="profile-initial-circle" id="myProfileInitial">
</div>
<div class="profile-username" id="myProfileUsername" style="font-size: 1.6em; color: #4b4f66; font-weight: 600;">
</div>
<div class="profile-stats">
<div class="profile-stat-item" style="margin: 10px; color: #5d74d0;">
<div class="profile-stat-number" id="myProfileFollowers">
         0
        </div>
<div class="profile-stat-label">
         Followers
        </div>
</div>
<div class="profile-stat-item" style="margin: 10px; color: #5d74d0;">
<div class="profile-stat-number" id="myProfileFollowing">
         0
        </div>
<div class="profile-stat-label">
         Following
        </div>
</div>
</div>
</div>
<h4>
      Bio
     </h4>
<h4>
      Profile Picture Emoji
     </h4>
<select id="profileEmojiSelect">
<option value="">
       Default
      </option>
<option value="üòÄ">
       üòÄ
      </option>
<option value="üòé">
       üòé
      </option>
<option value="ü•≥">
       ü•≥
      </option>
<option value="üî•">
       üî•
      </option>
<option value="üëë">
       üëë
      </option>
<option value="üíé">
       üíé
      </option>
<option value="üåü">
       üåü
      </option>
<option value="üê±">
       üê±
      </option>
<option value="ü¶Ñ">
       ü¶Ñ
      </option>
<option value="üôÇ">
       üôÇ
      </option>
</select>
<button onclick="saveProfileEmoji()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      Save Emoji
     </button>
<textarea id="profileBio" maxlength="150" placeholder="Tell us about yourself..." style="font-size: 1.2em; background: linear-gradient(135deg, #1f2937, #334155); border: 1px solid #ffbf00; padding: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5); background-color: #2a384e; color: #fff; padding: 15px; border-radius: 50px; text-align: left; min-height: 120px; margin-bottom: 15px; resize: vertical; width: calc(100% - 24px); font-size: 1.1em; line-height: 1.5;"></textarea>
<button id="saveBioBtn" onclick="saveMyBio()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      Save Bio
     </button>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
<div class="section" id="otherUserProfileSection">
<button onclick="backToUserList()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Users
     </button>
<h3>
      User Profile
     </h3>
<div class="profile-header">
<div class="profile-initial-circle" id="otherProfileInitial">
</div>
<div class="profile-username" id="otherProfileUsername">
</div>
<div class="profile-stats">
<div class="profile-stat-item" style="margin: 10px; color: #5d74d0;">
<div class="profile-stat-number" id="otherProfileFollowers">
         0
        </div>
<div class="profile-stat-label">
         Followers
        </div>
</div>
<div class="profile-stat-item" style="margin: 10px; color: #5d74d0;">
<div class="profile-stat-number" id="otherProfileFollowing">
         0
        </div>
<div class="profile-stat-label">
         Following
        </div>
</div>
</div>
</div>
<h4>
      Bio
     </h4>
<p id="otherProfileBio" style="color: #d1d9f5;">
      No bio available.
     </p>
<div class="profile-actions">
<button class="follow-btn" id="otherProfileFollowBtn" onclick="toggleFriendFromProfile()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Follow
      </button>
<button class="chat-btn" onclick="openChatFromProfile()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Chat
      </button>
<button class="send-btn" onclick="prepareSendMoneyFromProfile()" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
       Send
      </button>
</div>
</div>
<div class="section" id="mailboxSection">
<h3>
      ‚úâÔ∏è Mailbox
     </h3>
<div id="mailboxDisplay">
</div>
<button onclick="showScreen('dash')" style="background-color: #6c88d1; color: #fff; font-weight: bold; cursor: pointer; transition: background 0.3s ease, transform 0.1s ease; border-radius: 50px; padding: 12px 18px; border: none;">
      ‚¨Ö Back to Dashboard
     </button>
</div>
</div>
<div id="paymentAnimationOverlay">
<div class="payment-tick-circle">
<span>
      ‚úÖ
     </span>
</div>
<div class="payment-message">
     Payment Successful!
    </div>
</div>
<div id="popup">
</div>
<script>
    // Firebase configuration
const config = {
  apiKey: "AIzaSyBVrBb8k6jnHu1pLPTuywcxvy4Ac7Wh1F4",
  authDomain: "thunder-pay-7f22c.firebaseapp.com",
  databaseURL: "https://thunder-pay-7f22c-default-rtdb.firebaseio.com",
  projectId: "thunder-pay-7f22c",
  storageBucket: "thunder-pay-7f22c.appspot.com",
  messagingSenderId: "850869047425",
  appId: "1:850869047425:web:14dfce863c6b49b530fd80"
};
firebase.initializeApp(config);
const db = firebase.database();


// ‚úÖ Login Tracking Code
function trackLogin(username) {
  const now = new Date();
  const timeStr = now.toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  });
  db.ref('loginTracking').push({
    username: username,
    timestamp: now.toISOString(),
    timeStr: timeStr
  });
}

// Global variables
let user = "";
let balanceInterval;
let lastNotif = ""; // To prevent re-triggering old payment notifications
let currentChatPartner = null;
let chatRef = null;
let currentChatListener = null; // Listener for active chat messages
let seenStatusListener = null; // Listener for message seen status
let lastReceivedMessageSender = null; // To track sender of the last unread message for bell click
let ownerMessageListener = null; // Listener for owner messages
let ownerSupportListener = null; // Listener for new support messages for owner dot
let customerSupportReplyId = null; // ID of the customer support message being replied to
let ownerPin = "bholenath"; // Owner PIN
let currentProfileUser = null; // To store the username of the profile currently being viewed
let mailboxListener = null; // New: Listener for mailbox messages

// Predefined lists for chat content
const emojis = ["üòÄ", "üòÅ", "üòÇ", "ü§£", "üòä", "üòá", "üôÇ", "üôÉ", "üòâ", "üòå", "üòç", "ü•∞", "üòò", "üòó", "üòô", "üòö", "üòã", "üòõ", "üòú", "ü§™", "üòù", "ü§ë", "ü§ó", "ü§≠", "ü§´", "ü§î", "ü§ê", "ü§®", "üòê", "üòë", "üò∂", "üòè", "üòí", "üôÑ", "üò¨", "ü§•", "üòå", "üòî", "üò™", "ü§§", "üò¥", "üò∑", "ü§í", "ü§ï", "ü§¢", "ü§Æ", "ü§ß", "ü•µ", "ü•∂", "ü•¥", "üòµ", "ü§Ø", "ü§†", "ü•≥", "üòé", "ü§ì", "üßê", "üòï", "üòü", "üôÅ", "üòÆ", "üòØ", "üò≤", "üò≥", "ü•∫", "üò¶", "üòß", "üò®", "üò©", "ü§Ø", "üò°", "üò†", "ü§¨", "üòà", "üëø", "üíÄ", "üí©", "üëç", "üëé", "üëè", "üôè", "‚ù§Ô∏è", "üíî", "üíØ", "üî•", "‚ú®", "üéâ", "üí°", "üí∞", "üí∏", "üöÄ"];

const stickersAndGifts = [
    { content: 'ü•≥', type: 'sticker', styleClass: 'sticker-yellow' },
    { content: 'üëã', type: 'sticker', styleClass: 'sticker-blue' },
    { content: 'üëç', type: 'sticker', styleClass: 'sticker-green' },
    { content: 'üòÇ', type: 'sticker', styleClass: 'sticker-red' },
    { content: 'üéâ', type: 'sticker', styleClass: 'sticker-purple' },
    { content: 'üéÅ', type: 'gift', value: 'Gift Box' },
    { content: 'üí∞', type: 'gift', value: 'Money Bag' },
    { content: 'üíé', type: 'gift', value: 'Diamond' }
];

// --- Audio Functions ---
function playPaymentTone() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "square";
    o.frequency.setValueAtTime(800, ctx.currentTime);
    g.gain.setValueAtTime(0.9, ctx.currentTime);
    o.connect(g);
    g.connect(ctx.destination);
    o.start();
    o.frequency.linearRampToValueAtTime(1200, ctx.currentTime + 0.08);
    g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.2);
    o.stop(ctx.currentTime + 0.2);
  } catch (e) {
    console.log("‚ö†Ô∏è Tone error:", e);
  }
}

function playMessageSendTone() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "sine";
        o.frequency.setValueAtTime(440, ctx.currentTime);
        g.gain.setValueAtTime(0.8, ctx.currentTime);
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.1);
        o.stop(ctx.currentTime + 0.1);
    } catch (e) {
        console.log("‚ö†Ô∏è Message send tone error:", e);
    }
}

function playNotificationTone() {
    try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = "triangle";
        o.frequency.setValueAtTime(600, ctx.currentTime);
        g.gain.setValueAtTime(0.9, ctx.currentTime);
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        o.frequency.linearRampToValueAtTime(800, ctx.currentTime + 0.05);
        g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime + 0.3);
        o.stop(ctx.currentTime + 0.3);
    } catch (e) {
        console.log("‚ö†Ô∏è Notification tone error:", e);
    }
}

// --- Screen and UI Management ---
function showScreen(id) {
  // Detach all listeners and intervals before changing screens
  detachAllListeners();

  // Hide all main sections
  ["chooser", "signup", "login", "dash"].forEach(e => document.getElementById(e).classList.add("hidden"));
  
  // Show the requested screen
  document.getElementById(id).classList.remove("hidden");
  
  document.getElementById("settingsMenu").style.display = "none"; // Always hide settings menu when changing screens

  // Handle specific screen transitions
  if (id === 'dash') {
    // Hide all sub-sections within the dashboard initially
    document.querySelectorAll(".section").forEach(e => e.style.display = "none");
    // Show main dashboard content
    document.getElementById("dashboardMainContent").style.display = "block";
    document.getElementById("notificationBell").classList.remove("hidden"); // Show bell on dashboard
    document.getElementById("profileIconBtn").classList.remove("hidden"); // Show profile icon on dashboard
    if (user) {
      const now = new Date();
      const loginDateStr = now.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      db.ref("thunderPayUsers/" + user).update({
        lastLogin: now.toISOString(),
        lastLoginDateStr: loginDateStr
      });
      sessionStartTime = Date.now(); // Start session tracking
    }
    startDashboardListeners(); // Start all dashboard-related listeners
    if (user) {
      db.ref(`thunderPayUsers/${user}/status`).set(true); // Set user online status
    }
  } else {
      // If navigating away from dash, hide bell and profile icon and set user offline if logged in
      document.getElementById("notificationBell").classList.add("hidden");
      document.getElementById("profileIconBtn").classList.add("hidden");
      if (user) {
        db.ref(`thunderPayUsers/${user}/status`).set(false);
      }
  }
}

function showSub(id) {
  // Detach specific listeners before showing a new sub-section (especially chat)
  if (currentChatListener && chatRef) {
      chatRef.off('child_added', currentChatListener);
      currentChatListener = null;
      chatRef = null; // Clear chatRef when leaving chat
  }
  if (seenStatusListener) { 
      // If seenStatusListener was assigned using on('value', callback), need to store ref and detach properly
      // Assuming it's detached inside detachAllListeners, but for sub-section specific detach:
      if (currentChatPartner) { // Only detach if a chat partner was active
        const chatID = [user, currentChatPartner].sort().join('_');
        db.ref(`chats/${chatID}`).orderByChild('sender').equalTo(user).off('child_changed');
      }
      seenStatusListener = null; 
  }
  // New: Detach mailbox listener when leaving mailbox
  if (mailboxListener && id !== 'mailboxSection') {
      db.ref(`thunderPayUsers/${user}/mailbox`).off('child_added', mailboxListener);
      db.ref(`thunderPayUsers/${user}/mailbox`).off('child_removed', mailboxListener);
      mailboxListener = null;
  }

  // Hide all dashboard main content and all sub-sections first
  document.getElementById("dashboardMainContent").style.display = "none";
  document.querySelectorAll(".section").forEach(e => e.style.display = "none");
  
  // Show the requested sub-section
  document.getElementById(id).style.display = "block";
  document.getElementById("settingsMenu").style.display = "none"; // Hide settings menu

  // Specific actions for certain sub-sections
  if (id === 'history') {
    const transactionTabButton = document.querySelector('.tab-button[onclick*="transactionsHist"]');
    switchHistoryTab('transactionsHist', transactionTabButton); // Default to transactions tab
  } else if (id === 'userListSection') {
    const membersListTabButton = document.querySelector('.tab-button[onclick*="membersListContainer"]');
    switchUserListTab('membersListContainer', membersListTabButton); // Default to members list
  } else if (id === 'owner') {
    hideCustomerServiceReplyBox(); // Hide reply box when opening owner panel generally
    loadCustomerSupportMessagesForOwner(); // Load messages when owner panel is opened
    // Clear blue dot on owner panel once opened
    db.ref('ownerMessage/newSupportMessage').set(false);
    document.getElementById('ownerDot').classList.add('hidden');
    document.getElementById("verifiedUserToggleInput").value = ""; // Clear input on owner panel for verified users
    document.getElementById("verifiedStatusMsg").textContent = ""; // Clear status message
  } else if (id === 'myProfileSection') {
    loadMyProfile();
  } else if (id === 'mailboxSection') { // New: Load mailbox messages
    loadMailboxMessages();
  }
  // Ensure user status is online if on a sub-section of dash
  if (user) {
      db.ref(`thunderPayUsers/${user}/status`).set(true);
  }
}

function detachAllListeners() {
    clearInterval(balanceInterval);
    if (currentChatListener && chatRef) { chatRef.off('child_added', currentChatListener); currentChatListener = null; chatRef = null; }
    if (seenStatusListener) {
        // If seenStatusListener was assigned using on('value', callback), need to store ref and detach properly
        // Assuming it's detached inside detachAllListeners, but for sub-section specific detach:
        if (currentChatPartner) { // Only detach if a chat partner was active
            const chatID = [user, currentChatPartner].sort().join('_');
            db.ref(`chats/${chatID}`).orderByChild('sender').equalTo(user).off('child_changed');
        }
        seenStatusListener = null; 
    }
    // New: Detach mailbox listener
    if (mailboxListener) {
        db.ref(`thunderPayUsers/${user}/mailbox`).off('child_added', mailboxListener);
        db.ref(`thunderPayUsers/${user}/mailbox`).off('child_removed', mailboxListener);
        mailboxListener = null;
    }
    
    // Detach all general user-specific listeners
    if (user) {
        db.ref(`thunderPayUsers/${user}/hasNewMessage`).off();
        db.ref(`thunderPayUsers/${user}/lastMessageFrom`).off();
        db.ref(`thunderPayUsers/${user}/status`).off();
        db.ref(`thunderPayUsers/${user}/hasNewSupportReply`).off(); // Detach new support reply listener
        db.ref(`thunderPayUsers/${user}/followers`).off(); // Detach followers listener
        db.ref(`thunderPayUsers/${user}/following`).off(); // Detach following listener
    }
    
    // Detach owner-specific listeners
    if (ownerMessageListener) { db.ref("ownerMessage/current").off('value', ownerMessageListener); ownerMessageListener = null; }
    if (ownerSupportListener) { db.ref('ownerMessage/newSupportMessage').off('value', ownerSupportListener); ownerSupportListener = null; }
    
    console.log("All listeners detached.");
}

function startDashboardListeners() {
    // Only attach if user is logged in
    if (!user) return;
    
    // Re-attach status listener for the current user
    db.ref(`thunderPayUsers/${user}/status`).onDisconnect().set(false);
    db.ref(`thunderPayUsers/${user}/status`).set(true);

    // Start auto-balance interval
    clearInterval(balanceInterval); // Clear any old interval
    let lastRewardKey = null;
balanceInterval = setInterval(() => {
  db.ref(`thunderPayUsers/${user}/balance`).once("value", snap => {
    if (snap.exists()) bal.textContent = snap.val();
  });
  db.ref(`thunderPayUsers/${user}/history`).limitToLast(1).once("value", snap => {
    if (snap.exists()) {
      const entries = Object.entries(snap.val());
      const [key, last] = entries[0];
      if (last.includes("Got ‚Çπ") && last !== lastNotif && key !== lastRewardKey) {
        lastNotif = last;
        lastRewardKey = key;
        playPaymentTone();
        showPopup("ü™ô " + last);
      }
    }
  });
}, 1000);

    listenForNewMessages();
    checkAndDisplayOwnerMessage();
    listenForOwnerSupportMessages(); // For owner's dot
    listenForNewSupportReplies(); // Listen for new support replies for the user
    monitorMailbox();
  console.log("Dashboard listeners started.");
}


function toggleSettings() {
  const menu = document.getElementById("settingsMenu");
  menu.style.display = menu.style.display === "block" ? "none" : "block";
}

function showPopup(msg) {
  const p = document.getElementById("popup");
  p.textContent = msg;
  p.style.display = "block";
  setTimeout(() => p.style.display = "none", 4000);
}

function showPaymentSuccessAnimation() {
  const overlay = document.getElementById("paymentAnimationOverlay");
  overlay.classList.add("show");
  playPaymentTone();

  setTimeout(() => {
    overlay.classList.remove("show");
  }, 2500);
}

// --- Auth Functions ---
function signup() {
  const u = sUser.value.trim(), p = sPass.value.trim();
  if (!u || !p) return alert("Please fill all fields.");
  db.ref("thunderPayUsers/" + u).once("value", snap => {
    if (snap.exists()) return alert("Username already exists.");
    db.ref("thunderPayUsers/" + u).set({ password: p, balance: 0, lastSeenOwnerMessage: "", hasNewMessage: false, lastMessageFrom: "", status: false, following: [], followers: [], bio: "", verified: false }, () => { // Updated: added verified: false
      alert("Sign up successful!"); showScreen("login");
    });
  });
}

function login() {
  const u = lUser.value.trim(), p = lPass.value.trim();
  if (!u || !p) return alert("Please fill all fields.");
  db.ref("thunderPayUsers/" + u).once("value", snap => {
    if (!snap.exists()) return alert("User not found.");
    if (snap.val().password !== p) return alert("Incorrect password!");
    user = u;
    uname.textContent = u;
    receiveCode.textContent = u;
    bal.textContent = snap.val().balance;

    showScreen("dash");
    startDashboardListeners(); // Call the new function to start all dashboard listeners
    // Initialize lastNotif to prevent re-triggering old payment notifications on login
    db.ref(`thunderPayUsers/${user}/history`).limitToLast(1).once("value", historySnap => {
      if (historySnap.exists()) {
        const last = Object.values(historySnap.val())[0];
        lastNotif = last;
      } else {
        lastNotif = "";
      }
    });
    loadTransactionsHistory(); // Load transactions on login (or when history tab is opened)
  });
}

function logout() {
  detachAllListeners(); // Detach all listeners before logging out
  if (user) {
    db.ref(`thunderPayUsers/${user}/status`).set(false).then(() => { // Set user offline
        user = ""; // Clear user
        location.reload(); // Reload page
    });
  } else {
    location.reload(); // Reload anyway if user somehow not set
  }
}

// --- Dashboard Functions ---
// Moved balance update logic into startDashboardListeners()

function sendMoney() {
  const r = rec.value.trim(), a = parseInt(amt.value);
  if (!r || !a || a <= 0) return alert("Please enter recipient and valid amount.");
  if (r === user) return alert("You cannot send money to yourself!");

  document.getElementById("anim").classList.remove("hidden");

  db.ref("thunderPayUsers/" + user).once("value", s => {
    if (!s.exists() || s.val().balance < a) {
      document.getElementById("anim").classList.add("hidden");
      return alert("Insufficient balance!");
    }
    db.ref("thunderPayUsers/" + r).once("value", rs => {
      if (!rs.exists()) {
        document.getElementById("anim").classList.add("hidden");
        return alert("Recipient user not found.");
      }

      const nb = s.val().balance - a;
      const nr = rs.val().balance + a;
      const now = new Date().toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).replace(',', '');

      const updates = {};
      updates[`thunderPayUsers/${user}/balance`] = nb;
      updates[`thunderPayUsers/${r}/balance`] = nr;

      const userHistoryKey = db.ref(`thunderPayUsers/${user}/history`).push().key;
      const receiverHistoryKey = db.ref(`thunderPayUsers/${r}/history`).push().key;

      updates[`thunderPayUsers/${user}/history/${userHistoryKey}`] = `${now} | Sent ‚Çπ${a} to ${r}`;
      updates[`thunderPayUsers/${r}/history/${receiverHistoryKey}`] = `${now} | Got ‚Çπ${a} from ${user}`;

      db.ref().update(updates)
        .then(() => {
          document.getElementById("anim").classList.add("hidden");
          showPaymentSuccessAnimation();
          rec.value = "";
          amt.value = "";
          // Balance and history update will be handled by existing listeners if `startDashboardListeners` is active
        })
        .catch(error => {
          document.getElementById("anim").classList.add("hidden");
          alert("Transaction failed: " + error.message);
          console.error("Transaction failed:", error);
        });
    });
  });
}

function purchaseGift(amount) {
  giftResult.innerHTML = ""; // Clear previous results

  const loader = document.createElement("div");
  loader.className = "loader";
  giftResult.appendChild(loader); // Show loader

  db.ref("availableGiftCards").once("value", snap => {
    const all = snap.val();
    if (!all) {
      giftResult.innerHTML = "‚ùå No gift codes available.";
      return;
    }

    db.ref("giftCardsUsed").once("value", usedSnap => {
      const used = usedSnap.exists() ? Object.keys(usedSnap.val()) : [];
      const available = Object.entries(all)
        .filter(([code, d]) => d.amount === amount && !used.includes(code))
        .map(([code]) => code);

      if (!available.length) {
        giftResult.innerHTML = `‚ùå No ‚Çπ${amount} gift codes left.`;
        return;
      }

      db.ref("thunderPayUsers/" + user).once("value", usnap => {
        let bal = usnap.val().balance;
        if (bal < amount) {
          giftResult.innerHTML = "‚ùå Insufficient balance!";
          return;
        }

        const selectedCode = available[Math.floor(Math.random() * available.length)];
        bal -= amount;
        const now = new Date().toLocaleString('en-IN', {
            day: '2-digit', month: 'short', year: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        }).replace(',', '');

        const updates = {};
        updates[`thunderPayUsers/${user}/balance`] = bal;
        updates[`giftCardsUsed/${selectedCode}`] = { user, amount, time: now };

        db.ref().update(updates)
          .then(() => {
            setTimeout(() => {
              giftResult.innerHTML = `
                üéÅ Code: <b id="giftCode">${selectedCode}</b><br/>
                <button onclick="copyGiftCode()">üìã Copy</button>
              `;
              loadPurchaseHistory(); // Update purchase history immediately
              showPaymentSuccessAnimation();
            }, 1000); // Simulate a small delay for animation/processing
          })
          .catch(error => {
            giftResult.innerHTML = "‚ùå Purchase failed: " + error.message;
            console.error("Gift purchase failed:", error);
          });
      });
    });
  });
}

function copyGiftCode() {
  const code = document.getElementById("giftCode").textContent;
  navigator.clipboard.writeText(code).then(() => {
    alert("‚úÖ Code copied!");
  }).catch(err => {
    alert("‚ùå Failed to copy: " + err);
  });
}

function changePassword() {
  const np = newPass.value.trim();
  if (!np) return alert("Please enter a new password.");
  db.ref(`thunderPayUsers/${user}/password`).set(np, () => {
    alert("Password updated!");
    newPass.value = "";
  });
}

// --- History Functions ---
function switchHistoryTab(tabId, clickedButton) {
    document.querySelectorAll('.history-tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    document.getElementById(tabId).classList.remove('hidden');

    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    clickedButton.classList.add('active');

    if (tabId === 'transactionsHist') {
        loadTransactionsHistory();
    } else if (tabId === 'purchaseHist') {
        loadPurchaseHistory();
    }
}

function loadTransactionsHistory() {
  const transactionList = document.getElementById("transactionList");
  transactionList.innerHTML = '<div class="loader"></div>'; // Show loader

  db.ref(`thunderPayUsers/${user}/history`).once("value", snap => {
    transactionList.innerHTML = ""; // Clear loader
    if (!snap.exists() || Object.keys(snap.val()).length === 0) {
      const li = document.createElement("li");
      li.style.color = "#cbd5e1";
      li.style.textAlign = "center";
      li.style.padding = "20px";
      li.textContent = "No transactions found.";
      transactionList.appendChild(li);
      return;
    }

    const historyItems = Object.values(snap.val()).reverse(); // Newest first

    historyItems.forEach(txt => {
      // Filter out "Bought ‚Çπ" transactions from this list
      if (txt.includes("Bought ‚Çπ")) {
          return;
      }

      const parts = txt.split(' | ');
      if (parts.length < 2) return;

      const dateTime = parts[0];
      let typeText = "";
      let amountValue = "";
      let detailsText = "";
      let iconInitial = "";
      let amountClass = "";

      if (parts[1].includes("Sent ‚Çπ")) {
        typeText = "Money Sent";
        amountValue = "‚Çπ" + parts[1].split('‚Çπ')[1].split(' ')[0];
        detailsText = "to " + parts[1].split('to ')[1];
        iconInitial = detailsText.replace('to ', '').charAt(0).toUpperCase();
        amountClass = "amount-sent";
      } else if (parts[1].includes("Got ‚Çπ")) {
        typeText = "Money Received";
        amountValue = "‚Çπ" + parts[1].split('‚Çπ')[1].split(' ')[0];
        detailsText = "from " + parts[1].split('from ')[1];
        iconInitial = detailsText.replace('from ', '').charAt(0).toUpperCase();
        amountClass = "amount-received";
      } else if (parts[1].includes("added by Owner")) {
        typeText = "Money Added";
        amountValue = "‚Çπ" + parts[1].split('‚Çπ')[1].split(' ')[0];
        detailsText = "by Owner";
        iconInitial = "O";
        amountClass = "amount-owner";
      } else {
        typeText = "Unknown Transaction";
        amountValue = "";
        detailsText = parts[1];
        iconInitial = "?";
      }

      const li = document.createElement("li");
      li.classList.add("transaction-item");

      li.innerHTML = `
        <div class="transaction-icon">${iconInitial}</div>
        <div class="transaction-details">
          <div class="transaction-main-text">${typeText}</div>
          <div class="transaction-sub-text">${detailsText}</div>
        </div>
        <div class="transaction-amount ${amountClass}">${amountValue}</div>
        <div class="transaction-date">${dateTime.split(' ')[0]} ${dateTime.split(' ')[1]} ${dateTime.split(' ')[2]}</div>
      `;
      transactionList.appendChild(li);
    });
     if (transactionList.children.length === 0) { // If no items were added after filtering
        const li = document.createElement("li");
        li.style.color = "#cbd5e1";
        li.style.textAlign = "center";
        li.style.padding = "20px";
        li.textContent = "No transactions found.";
        transactionList.appendChild(li);
     }
  });
}

function loadPurchaseHistory() {
  const purchaseList = document.getElementById("purchaseList");
  purchaseList.innerHTML = '<div class="loader"></div>'; // Show loader

  db.ref("giftCardsUsed").once("value", snap => {
    purchaseList.innerHTML = ""; // Clear loader
    if (!snap.exists()) {
      const li = document.createElement("li");
      li.style.color = "#cbd5e1";
      li.style.textAlign = "center";
      li.style.padding = "20px";
      li.textContent = "No purchase history.";
      purchaseList.appendChild(li);
      return;
    }

    const purchasedItems = Object.entries(snap.val())
      .filter(([, data]) => data.user === user) // Filter for current user's purchases
      .reverse(); // Newest first

    if (purchasedItems.length === 0) {
      const li = document.createElement("li");
      li.style.color = "#cbd5e1";
      li.style.textAlign = "center";
      li.style.padding = "20px";
      li.textContent = "No purchase history.";
      purchaseList.appendChild(li);
      return;
    }

    purchasedItems.forEach(([code, data]) => {
      const li = document.createElement("li");
      li.classList.add("transaction-item"); // Reuse existing styling

      li.innerHTML = `
        <div class="transaction-icon">G</div>
        <div class="transaction-details">
          <div class="transaction-main-text">Gift Card Purchased</div>
          <div class="transaction-sub-text">Code: ${code}</div>
        </div>
        <div class="transaction-amount amount-bought">‚Çπ${data.amount}</div>
        <div class="transaction-date">${data.time.split(' ')[0]} ${data.time.split(' ')[1]} ${data.time.split(' ')[2]}</div>
        <div class="transaction-view-code" onclick="alert('Gift Code: ${code}')">View Code</div>
      `;
      purchaseList.appendChild(li);
    });
  });
}

// --- Owner Panel Functions ---
function authOwner() {
  if (pin.value === ownerPin) { // Use the ownerPin variable
    ownerBox.classList.remove("hidden");
    ownerMsg.textContent = "Unlocked.";
    loadCustomerSupportMessagesForOwner(); // Load messages when owner panel is opened
    // Clear blue dot on owner panel once opened
    db.ref('ownerMessage/newSupportMessage').set(false); // Reset new support message flag
    document.getElementById('ownerDot').classList.add('hidden');
  } else {
    alert("Incorrect PIN!");
  }
  pin.value = "";
}

function addCode() {
  const code = newCode.value.trim();
  const amt = parseInt(newCodeAmt.value);
  if (!code || !(amt === 10 || amt === 20)) return alert("Please enter code and correct amount (10 or 20).");
  db.ref(`availableGiftCards/${code}`).set({ amount: amt }, () => {
    ownerMsg.textContent = `${code} added for ‚Çπ${amt}.`;
    newCode.value = "";
    newCodeAmt.value = "";
  });
}

function addMoney() {
  const u = document.getElementById("addUser").value.trim();
  const a = parseInt(document.getElementById("addAmt").value);
  if (!u || !a || a <= 0) return alert("Please enter username and valid amount.");
  db.ref("thunderPayUsers/" + u).once("value", snap => {
    if (!snap.exists()) return alert("User not found.");
    const newBal = snap.val().balance + a;
    db.ref("thunderPayUsers/" + u + "/balance").set(newBal);
    const now = new Date().toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const historyKey = db.ref(`thunderPayUsers/${u}/history`).push().key;
    db.ref(`thunderPayUsers/${u}/history/${historyKey}`).set(`${now} | ‚Çπ${a} added by Owner`);
    alert("‚úÖ Money added successfully!");
    document.getElementById("addUser").value = "";
    document.getElementById("addAmt").value = "";
    // No need to load history for the current user here, as it's for another user
  });
}

function setOwnerMessage() {
    const message = document.getElementById("ownerMessageInput").value.trim();
    if (!message) {
        ownerMsg.textContent = "Please enter a message.";
        return;
    }
    db.ref("ownerMessage/current").set(message)
        .then(() => {
            ownerMsg.textContent = "Owner message set successfully!";
            document.getElementById("ownerMessageInput").value = "";
            // New: Send this message to all users' mailboxes
            sendOwnerMessageToMailboxes(message);
        })
        .catch(error => {
            ownerMsg.textContent = "Failed to set message: " + error.message;
        });
}

// New: Send owner message to all users' mailboxes
function sendOwnerMessageToMailboxes(message) {
    db.ref("thunderPayUsers").once("value", (snapshot) => {
        if (snapshot.exists()) {
            const users = snapshot.val();
            const updates = {};
            const now = new Date().toLocaleString('en-IN', {
                day: '2-digit', month: 'short', year: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            }).replace(',', '');

            for (const uid in users) {
                if (users.hasOwnProperty(uid)) {
                    // Push a new message to each user's mailbox
                    const newMailboxMessageKey = db.ref(`thunderPayUsers/${uid}/mailbox`).push().key;
                    updates[`thunderPayUsers/${uid}/mailbox/${newMailboxMessageKey}`] = {
                        sender: 'Owner',
                        subject: 'Important Announcement',
                        message: message,
                        timestamp: now,
                        read: false
                    };
                }
            }
            db.ref().update(updates)
                .then(() => {
                    console.log("Owner message sent to all user mailboxes.");
                })
                .catch(error => {
                    console.error("Error sending owner message to mailboxes:", error);
                });
        }
    });
}

function checkAndDisplayOwnerMessage() {
    if (ownerMessageListener) { // Detach previous listener if exists
        db.ref("ownerMessage/current").off('value', ownerMessageListener); // Correctly detach
    }
    ownerMessageListener = db.ref("ownerMessage/current").on("value", ownerSnap => {
        const currentOwnerMessage = ownerSnap.val();

        if (currentOwnerMessage) {
            db.ref(`thunderPayUsers/${user}/lastSeenOwnerMessage`).once("value", userSnap => {
                const lastSeenMessage = userSnap.val();

                if (currentOwnerMessage && currentOwnerMessage !== lastSeenMessage) {
                    showPopup("üì¢ Owner's Message: " + currentOwnerMessage);
                    // Update user's last seen message
                    db.ref(`thunderPayUsers/${user}/lastSeenOwnerMessage`).set(currentOwnerMessage);
                }
            });
        }
    });
}

// New: Toggle Verified Status
function toggleVerifiedStatus() {
    const username = document.getElementById("verifiedUserToggleInput").value.trim();
    const statusMsg = document.getElementById("verifiedStatusMsg");
    statusMsg.textContent = ''; // Clear previous message

    if (!username) {
        statusMsg.textContent = "Please enter a username.";
        return;
    }

    db.ref(`thunderPayUsers/${username}`).once("value", snap => {
        if (!snap.exists()) {
            statusMsg.textContent = `User "${username}" not found.`;
            return;
        }

        const currentVerifiedStatus = snap.val().verified || false;
        const newStatus = !currentVerifiedStatus;

        db.ref(`thunderPayUsers/${username}/verified`).set(newStatus)
            .then(() => {
                statusMsg.textContent = `User "${username}" is now ${newStatus ? 'Verified (Blue Tick On)' : 'Unverified (Blue Tick Off)'}.`;
                document.getElementById("verifiedUserToggleInput").value = "";
                // Refresh user list if visible to show/hide blue tick
                if (document.getElementById('userListSection').style.display === 'block' && 
                    document.getElementById('membersListContainer').classList.contains('active')) {
                    showAllUsers();
                }
            })
            .catch(error => {
                statusMsg.textContent = "Failed to update verified status: " + error.message;
                console.error("Error toggling verified status:", error);
            });
    });
}

// --- User List and Friends Functions ---
let allUsersData = {}; // Cache for all user data

function switchUserListTab(tabId, clickedButton) {
    document.querySelectorAll('.user-list-tab-content').forEach(tab => {
        tab.classList.add('hidden');
    });
    document.getElementById(tabId).classList.remove('hidden');

    document.querySelectorAll('.tab-button').forEach(button => {
        button.classList.remove('active');
    });
    clickedButton.classList.add('active');

    // Call relevant function to load data, then filter
    if (tabId === 'membersListContainer') {
        showAllUsers();
    } else if (tabId === 'friendsListContainer') {
        showFriendsList();
    }
    document.getElementById("userSearchInput").value = ""; // Clear search when switching tabs
    // filterUserList() will be called inside showAllUsers/showFriendsList after data is loaded.
}

function showAllUsers() {
    const usersList = document.getElementById("membersList");
    usersList.innerHTML = '<div class="loader"></div>';

    db.ref("thunderPayUsers").once("value", snap => {
        usersList.innerHTML = "";
        allUsersData = snap.val() || {};

        if (!snap.exists() || Object.keys(allUsersData).length === 0) {
            const li = document.createElement("li");
            li.style.color = "#cbd5e1";
            li.style.textAlign = "center";
            li.style.padding = "20px";
            li.textContent = "No users found.";
            usersList.appendChild(li);
            return;
        }

        const currentUserFollowing = allUsersData[user]?.following || [];
        let foundUsers = false;

        // Sort users: verified first, then alphabetically
        const sortedUsernames = Object.keys(allUsersData).sort((a, b) => {
            const userA = allUsersData[a];
            const userB = allUsersData[b];

            // Current user always at the bottom if sorting by verified status
            if (a === user) return 1;
            if (b === user) return -1;

            const isAVerified = userA?.verified || false;
            const isBVerified = userB?.verified || false;

            if (isAVerified && !isBVerified) return -1; // A is verified, B is not, A comes first
            if (!isAVerified && isBVerified) return 1;  // B is verified, A is not, B comes first
            
            return a.localeCompare(b); // Alphabetical for same verification status
        });

        sortedUsernames.forEach(username => {
            if (username === user) {
                return; // Skip current user
            }
            foundUsers = true;
            const userData = allUsersData[username];
            const li = document.createElement("li");
            li.setAttribute('data-username', username);
            li.onclick = (event) => {
                if (event.target.tagName !== 'BUTTON') {
                    openUserProfile(username);
                }
            };
            
            const initialDiv = document.createElement("div");
            initialDiv.className = "initial-circle";
            initialDiv.textContent = username.charAt(0).toUpperCase();

            const statusDot = document.createElement("span");
            statusDot.className = userData.status ? "online-dot" : "offline-dot";
            initialDiv.appendChild(statusDot);

            const usernameSpan = document.createElement("span");
            usernameSpan.textContent = username;
            usernameSpan.style.flexGrow = "1";
            usernameSpan.style.marginRight = "10px";

            // Add verified badge
            if (userData.verified) {
                const verifiedBadge = document.createElement("span");
                verifiedBadge.classList.add("verified-badge");
                verifiedBadge.innerHTML = '&#10003;'; // Unicode for checkmark
                usernameSpan.appendChild(verifiedBadge);
            }

            // Add action buttons for "Members List"
            const actionsDiv = document.createElement("div");
            actionsDiv.className = "user-actions";

            const followBtn = document.createElement("button");
            followBtn.classList.add("follow-btn");
            followBtn.textContent = currentUserFollowing.includes(username) ? "Following" : "Follow";
            if (currentUserFollowing.includes(username)) {
                followBtn.disabled = true; // Disable if already following
                followBtn.style.opacity = '0.7'; // Visually indicate disabled
            }
            followBtn.onclick = (event) => {
                event.stopPropagation(); // Prevent li.onclick from firing
                toggleFriend(username, followBtn);
            };
            actionsDiv.appendChild(followBtn);
            
            li.appendChild(initialDiv);
            li.appendChild(usernameSpan);
            li.appendChild(actionsDiv);

            usersList.appendChild(li);

            // Listen for changes in this user's online status
            db.ref(`thunderPayUsers/${username}/status`).on('value', (statusSnap) => {
                if (statusSnap.exists()) {
                    if (statusSnap.val() === true) {
                        statusDot.classList.remove("offline-dot");
                        statusDot.classList.add("online-dot");
                    } else {
                        statusDot.classList.remove("online-dot");
                        statusDot.classList.add("offline-dot");
                    }
                }
            });
        });
        
        if (!foundUsers && sortedUsernames.filter(u => u !== user).length === 0) { // Check if there are truly no other users
            const li = document.createElement("li");
            li.style.color = "#cbd5e1";
            li.style.textAlign = "center";
            li.style.padding = "20px";
            li.textContent = "No users found.";
            usersList.appendChild(li);
        }
        filterUserList(); // Call filter after all users are loaded
    }).catch(error => {
        usersList.innerHTML = "";
        const li = document.createElement("li");
        li.style.color = "#ef4444";
        li.style.textAlign = "center";
        li.style.padding = "20px";
        li.textContent = "Error loading users: " + error.message;
        usersList.appendChild(li);
        console.error("Error loading users:", error);
    });
}

function showFriendsList() {
    const friendsList = document.getElementById("friendsList");
    friendsList.innerHTML = '<div class="loader"></div>';

    // Using .on() here to keep friend list dynamic if friends change
    db.ref(`thunderPayUsers/${user}/following`).on("value", followingSnap => { // Changed to 'following'
        friendsList.innerHTML = ""; // Clear existing list
        const followingUsernames = followingSnap.val() || [];

        if (followingUsernames.length === 0) {
            const li = document.createElement("li");
            li.style.color = "#cbd5e1";
            li.style.textAlign = "center";
            li.style.padding = "20px";
            li.textContent = "No friends added.";
            friendsList.appendChild(li);
            filterUserList(); // Call filter even if empty
            return;
        }

        let loadedFriends = 0;
        const friendItems = []; // To store created li elements before appending

        followingUsernames.forEach(friendUsername => {
            db.ref(`thunderPayUsers/${friendUsername}`).once("value", friendSnap => {
                loadedFriends++;
                if (friendSnap.exists()) {
                    const friendData = friendSnap.val();
                    const li = document.createElement("li");
                    li.setAttribute('data-username', friendUsername);
                    li.classList.add("user-item");
                    li.onclick = (event) => {
                        // Only open profile if the click wasn't on a button
                        if (event.target.tagName !== 'BUTTON') {
                            openUserProfile(friendUsername);
                        }
                    };

                    const initialDiv = document.createElement("div");
                    initialDiv.className = "initial-circle";
                    initialDiv.textContent = friendUsername.charAt(0).toUpperCase();

                    const statusDot = document.createElement("span");
                    statusDot.className = friendData.status ? "online-dot" : "offline-dot";
                    initialDiv.appendChild(statusDot);

                    const usernameSpan = document.createElement("span");
                    usernameSpan.textContent = friendUsername;
                    usernameSpan.style.flexGrow = "1";
                    usernameSpan.style.marginRight = "10px";

                     // Add verified badge
                    if (friendData.verified) {
                        const verifiedBadge = document.createElement("span");
                        verifiedBadge.classList.add("verified-badge");
                        verifiedBadge.innerHTML = '&#10003;'; // Unicode for checkmark
                        usernameSpan.appendChild(verifiedBadge);
                    }

                    // Add Chat and Send buttons for "Friendlist"
                    const actionsDiv = document.createElement("div");
                    actionsDiv.className = "user-actions";

                    const chatBtn = document.createElement("button");
                    chatBtn.classList.add("chat-btn");
                    chatBtn.textContent = "Chat";
                    chatBtn.onclick = (event) => {
                        event.stopPropagation(); // Prevent li.onclick from firing
                        openChat(friendUsername);
                    };
                    actionsDiv.appendChild(chatBtn);

                    const sendBtn = document.createElement("button");
                    sendBtn.classList.add("send-btn");
                    sendBtn.textContent = "Send";
                    sendBtn.onclick = (event) => {
                        event.stopPropagation(); // Prevent li.onclick from firing
                        prepareSendMoney(friendUsername);
                    };
                    actionsDiv.appendChild(sendBtn);
                    
                    li.appendChild(initialDiv);
                    li.appendChild(usernameSpan);
                    li.appendChild(actionsDiv);
                    friendItems.push(li); // Add to temp array

                    // Real-time status update for friends
                    db.ref(`thunderPayUsers/${friendUsername}/status`).on('value', (statusSnap) => {
                        if (statusSnap.exists()) {
                            if (statusSnap.val() === true) {
                                statusDot.classList.remove("offline-dot");
                                statusDot.classList.add("online-dot");
                            } else {
                                statusDot.classList.remove("online-dot");
                                statusDot.classList.add("offline-dot");
                            }
                        }
                    });

                } else {
                    // Friend user does not exist, clean up from friend list
                    db.ref(`thunderPayUsers/${user}/following`).once('value', currentFollowingSnap => { // Changed to 'following'
                        let currentFollowing = currentFollowingSnap.val() || [];
                        const updatedFollowing = currentFollowing.filter(f => f !== friendUsername);
                        if (updatedFollowing.length !== currentFollowing.length) {
                            db.ref(`thunderPayUsers/${user}/following`).set(updatedFollowing); // Changed to 'following'
                        }
                    });
                }

                // If all friends processed, append them to the list
                if (loadedFriends === followingUsernames.length) {
                    friendItems.sort((a, b) => a.getAttribute('data-username').localeCompare(b.getAttribute('data-username'))); // Optional: sort alphabetically
                    friendItems.forEach(item => friendsList.appendChild(item));
                    if (friendsList.children.length === 0) { // If no actual friend items were appended (e.g., all deleted)
                         const li = document.createElement("li");
                        li.style.color = "#cbd5e1";
                        li.style.textAlign = "center";
                        li.style.padding = "20px";
                        li.textContent = "No friends added.";
                        friendsList.appendChild(li);
                    }
                    filterUserList(); // Call filter after all friends are loaded
                }
            });
        });
    });
}


function toggleFriend(targetUsername, buttonElement) {
    // This function is now primarily called from the profile view
    // The buttonElement is passed to update its text and style
    db.ref(`thunderPayUsers/${user}/following`).once("value", snap => {
        let followingList = snap.val() || [];
        const index = followingList.indexOf(targetUsername);

        if (index > -1) {
            // Unfollow - This action should ideally be done from the profile page
            // For the list button, we want to prevent unfollowing directly from "Members List"
            // or if it was explicitly a "Follow" button.
            // The button on members list will say "Following" and be disabled if already following.
            // So this 'if' block primarily runs from the profile page's 'Unfollow' button.
            followingList.splice(index, 1);
            db.ref(`thunderPayUsers/${user}/following`).set(followingList)
                .then(() => {
                    // Also remove from target user's followers list
                    db.ref(`thunderPayUsers/${targetUsername}/followers`).once("value", targetSnap => {
                        let targetFollowers = targetSnap.val() || [];
                        const targetIndex = targetFollowers.indexOf(user);
                        if (targetIndex > -1) {
                            targetFollowers.splice(targetIndex, 1);
                            db.ref(`thunderPayUsers/${targetUsername}/followers`).set(targetFollowers);
                        }
                    });
                    showPopup(`You have unfollowed ${targetUsername}.`); // Use popup for feedback
                    if (buttonElement) { // Update button on profile
                        buttonElement.textContent = 'Follow';
                        buttonElement.classList.remove('unfollow-btn');
                        buttonElement.classList.add('follow-btn');
                    }
                    // Re-render members list and friend list to update 'Follow/Following' state
                    showAllUsers(); 
                    showFriendsList();
                    if (document.getElementById('otherUserProfileSection').style.display === 'block' && currentProfileUser === targetUsername) {
                         loadOtherUserProfile(targetUsername); // Reload profile to update counts and button
                    }
                })
                .catch(error => {
                    alert("Failed to unfollow: " + error.message);
                });
        } else {
            // Follow
            followingList.push(targetUsername);
            db.ref(`thunderPayUsers/${user}/following`).set(followingList)
                .then(() => {
                    // Also add to target user's followers list
                    db.ref(`thunderPayUsers/${targetUsername}/followers`).once("value", targetSnap => {
                        let targetFollowers = targetSnap.val() || [];
                        if (!targetFollowers.includes(user)) {
                            targetFollowers.push(user);
                            db.ref(`thunderPayUsers/${targetUsername}/followers`).set(targetFollowers);
                        }
                    });
                    showPopup(`You are now following ${targetUsername}!`); // Use popup for feedback
                    if (buttonElement) { // Update button on profile
                        buttonElement.textContent = 'Unfollow'; // On profile, it becomes Unfollow
                        buttonElement.classList.remove('follow-btn');
                        buttonElement.classList.add('unfollow-btn');
                    }
                    // If this was from the members list, disable the button and change text to "Following"
                    if (buttonElement && buttonElement.closest('#membersList')) {
                        buttonElement.textContent = 'Following';
                        buttonElement.disabled = true;
                        buttonElement.style.opacity = '0.7';
                    }
                    // Re-render members list and friend list to update 'Follow/Following' state
                    showAllUsers(); 
                    showFriendsList();
                    if (document.getElementById('otherUserProfileSection').style.display === 'block' && currentProfileUser === targetUsername) {
                        loadOtherUserProfile(targetUsername); // Reload profile to update counts and button
                    }
                })
                .catch(error => {
                    alert("Failed to follow: " + error.message);
                });
        }
    });
}

function filterUserList() {
    const input = document.getElementById("userSearchInput").value.toLowerCase();
    const activeTabId = document.querySelector('.user-list-tab-content:not(.hidden)').id;
    const listId = activeTabId === 'membersListContainer' ? 'membersList' : 'friendsList';
    const listItems = document.getElementById(listId).getElementsByTagName("li");

    console.log('--- Filtering User List ---');
    console.log('Search input:', input);
    console.log('Active list ID:', listId);
    console.log('Number of list items to process:', listItems.length);

    let itemsShown = 0;
    for (let i = 0; i < listItems.length; i++) {
        const usernameSpan = listItems[i].querySelector('span:not(.initial-circle)');
        if (usernameSpan) {
            // Get the raw username without the verified badge for filtering
            const usernameText = usernameSpan.firstChild.textContent.toLowerCase(); 
            console.log(`  Processing item ${i}: User "${usernameText}", Input "${input}"`);
            if (usernameText.includes(input)) {
                listItems[i].style.display = "flex"; // Show item
                itemsShown++;
                console.log(`    MATCH: Showing ${usernameText}`);
            } else {
                listItems[i].style.display = "none"; // Hide item
                console.log(`    NO MATCH: Hiding ${usernameText}`);
            }
        } else {
            console.warn(`  Item ${i} (${listItems[i].getAttribute('data-username') || 'Unknown'}): usernameSpan not found. Skipping.`);
        }
    }
    console.log(`--- Filter Complete. ${itemsShown} items shown. ---`);
    if (itemsShown === 0 && listItems.length > 0) {
      // If no items are shown but there were items to begin with, this means search returned no results.
      // You might want to display a "No results found" message here if desired.
      // For now, it will just show an empty list.
    }
}


function prepareSendMoney(receiverUsername) {
    showSub('send');
    document.getElementById('rec').value = receiverUsername;
    document.getElementById('amt').value = '';
    document.getElementById('rec').focus();
}

// --- Chat Functions ---
function openChat(targetUser) {
    currentChatPartner = targetUser;
    document.getElementById("chatPartnerName").textContent = `Chat: ${targetUser}`;
    document.getElementById("messagesDisplay").innerHTML = ""; // Clear previous messages
    document.getElementById("chatInput").value = ""; // Clear input field
    document.getElementById("chatContentPicker").style.display = "none"; // Hide picker when opening chat

    showSub('chatSection'); // This will hide all other sections and show chatSection

    const chatID = [user, targetUser].sort().join('_');
    chatRef = db.ref(`chats/${chatID}`);

    // Detach any previous chat listeners before attaching new ones
    if (currentChatListener) {
        chatRef.off('child_added', currentChatListener);
        currentChatListener = null;
    }
    if (seenStatusListener) {
        // This listener is specific to messages SENT BY CURRENT USER to the chat partner.
        // Needs proper path to detach
        db.ref(`chats/${[user, currentChatPartner].sort().join('_')}`).orderByChild('sender').equalTo(user).off('child_changed', seenStatusListener);
        seenStatusListener = null;
    }

    // Load existing messages and listen for new ones
    currentChatListener = chatRef.on('child_added', (snapshot) => {
        const messageData = snapshot.val();
        const messageId = snapshot.key;
        displayMessage(messageData, messageId);

        // Mark messages as seen if current user is the receiver and message is not already seen
        if (messageData.receiver === user && !messageData.seen) {
            chatRef.child(messageId).update({ seen: true });
        }
        // If this message came from currentChatPartner, clear the notification dot
        if (messageData.sender === currentChatPartner) {
            db.ref(`thunderPayUsers/${user}`).update({ hasNewMessage: false, lastMessageFrom: "" });
            // The notification dot visibility is now managed by listenForNewMessages, so no direct hidden class toggling here
        }
    });

    // Listen for changes in 'seen' status for messages sent by THIS user to currentChatPartner
    // This is now detached and re-attached properly
    seenStatusListener = chatRef.orderByChild('sender').equalTo(user).on('child_changed', (snapshot) => {
        const changedMessage = snapshot.val();
        const messageId = snapshot.key;
        if (changedMessage.seen && changedMessage.receiver === currentChatPartner) {
            const messageElement = document.getElementById(`msg-${messageId}`);
            if (messageElement) {
                const tickElement = messageElement.querySelector('.message-tick');
                if (tickElement) {
                    tickElement.textContent = '‚úîÔ∏è‚úîÔ∏è';
                    tickElement.classList.add('seen');
                }
            }
        }
    });

    // Scroll to bottom after loading messages
    setTimeout(() => {
        const messagesDisplay = document.getElementById("messagesDisplay");
        messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
    }, 100);
}

function displayMessage(messageData, messageId) {
    const messagesDisplay = document.getElementById("messagesDisplay");
    const p = document.createElement("p");
    p.id = `msg-${messageId}`;

    const date = new Date(messageData.timestamp);
    const timeString = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    const dateString = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });

    let tickHtml = '';
    let reactionButtonHtml = '';
    let reactionsDisplayHtml = '';

    if (messageData.sender === user) {
        const tickClass = messageData.seen ? 'seen' : '';
        const tickContent = messageData.seen ? '‚úîÔ∏è‚úîÔ∏è' : '‚úîÔ∏è';
        tickHtml = `<span class="message-tick ${tickClass}">${tickContent}</span>`;
        p.classList.add("my-message");
        reactionButtonHtml = `<button class="react-button" onclick="toggleMessageReaction('${messageId}', 'üëç')">üëç</button>`; // React button for my messages
    } else {
        p.classList.add("other-message");
        reactionButtonHtml = `<button class="react-button" onclick="toggleMessageReaction('${messageId}', 'üëç')">üëç</button>`; // React button for other messages
    }

    // Display reactions
    if (messageData.reactions) {
        reactionsDisplayHtml += '<div class="message-reactions">';
        for (const emoji in messageData.reactions) {
            const users = messageData.reactions[emoji];
            const reactedByMe = users.includes(user) ? ' reacted-by-me' : '';
            reactionsDisplayHtml += `
                <span class="reaction-item${reactedByMe}" onclick="toggleMessageReaction('${messageId}', '${emoji}')">
                    ${emoji} ${users.length}
                </span>
            `;
        }
        reactionsDisplayHtml += '</div>';
    }

    p.innerHTML = `${messageData.message}${reactionButtonHtml}<br><span class="message-timestamp">${dateString}, ${timeString}</span>${tickHtml}${reactionsDisplayHtml}`;
    messagesDisplay.appendChild(p);
    messagesDisplay.scrollTop = messagesDisplay.scrollHeight;
}

function sendMessage() {
    const chatInput = document.getElementById("chatInput");
    const messageText = chatInput.value.trim();

    if (!messageText || !currentChatPartner || !chatRef) {
        return;
    }

    const newMessage = {
        sender: user,
        receiver: currentChatPartner,
        message: messageText,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        seen: false,
        reactions: {} // Initialize reactions object
    };

    chatRef.push(newMessage)
        .then(() => {
            chatInput.value = "";
            playMessageSendTone();
            document.getElementById("chatContentPicker").style.display = "none"; // Hide picker after sending

            // Update the receiver's hasNewMessage status
            db.ref(`thunderPayUsers/${currentChatPartner}`).update({
                hasNewMessage: true,
                lastMessageFrom: user
            });
        })
        .catch(error => {
            alert("Failed to send message: " + error.message);
            console.error("Error sending message:", error);
        });
}

function backToUserList() {
    // Detach chat-specific listeners
    if (currentChatListener && chatRef) {
        chatRef.off('child_added', currentChatListener);
        currentChatListener = null;
        chatRef = null;
    }
    if (seenStatusListener && currentChatPartner) {
        const chatID = [user, currentChatPartner].sort().join('_');
        db.ref(`chats/${chatID}`).orderByChild('sender').equalTo(user).off('child_changed', seenStatusListener);
        seenStatusListener = null;
    }
    currentChatPartner = null; // Clear current chat partner
    document.getElementById("chatContentPicker").style.display = "none"; // Hide picker when going back

    showSub('userListSection'); // Go back to the user list
}

function listenForNewMessages() {
    if (!user) return;

    const notificationDot = document.getElementById("notificationDot");

    // Detach existing listeners before re-attaching
    db.ref(`thunderPayUsers/${user}/hasNewMessage`).off();
    db.ref(`thunderPayUsers/${user}/lastMessageFrom`).off();
    db.ref(`thunderPayUsers/${user}/hasNewSupportReply`).off(); // Detach support reply listener from here

    // Listen for new chat messages
    db.ref(`thunderPayUsers/${user}/hasNewMessage`).on('value', (snapshot) => {
        const hasNewChat = snapshot.val();
        notificationDot.setAttribute('data-has-chat-message', hasNewChat ? 'true' : 'false');
        updateNotificationBellVisibility();
        if (hasNewChat) { // Play tone for chat messages
            db.ref(`thunderPayUsers/${user}/lastMessageFrom`).once('value', (senderSnap) => {
                const sender = senderSnap.val();
                const chatSectionElement = document.getElementById('chatSection');
                // Play tone only if not currently in chat with the sender AND chat section is not visible
                if (chatSectionElement.style.display === 'none' || currentChatPartner !== sender) { // Play if chat section is hidden OR if we are in chat but not with this specific sender (edge case)
                    playNotificationTone();
                }
            });
        }
    });

    // Listen for new support replies (separate listener now)
    db.ref(`thunderPayUsers/${user}/hasNewSupportReply`).on('value', (snapshot) => {
        const hasNewReply = snapshot.val();
        notificationDot.setAttribute('data-has-support-reply', hasNewReply ? 'true' : 'false');
        updateNotificationBellVisibility();
        if (hasNewReply) {
            playNotificationTone();
        }
    });

    db.ref(`thunderPayUsers/${user}/lastMessageFrom`).on('value', (snapshot) => {
        lastReceivedMessageSender = snapshot.val();
    });
    updateNotificationBellVisibility(); // Initial check
}

function updateNotificationBellVisibility() {
    const notificationDot = document.getElementById("notificationDot");
    const hasNewChat = notificationDot.getAttribute('data-has-chat-message') === 'true';
    const hasNewSupportReply = notificationDot.getAttribute('data-has-support-reply') === 'true';

    if (hasNewChat || hasNewSupportReply) {
        notificationDot.classList.remove("hidden");
    } else {
        notificationDot.classList.add("hidden");
    }
}


function handleBellClick() {
    const notificationDot = document.getElementById("notificationDot");
    const hasNewChat = notificationDot.getAttribute('data-has-chat-message') === 'true';
    const hasNewSupportReply = notificationDot.getAttribute('data-has-support-reply') === 'true';

    if (!hasNewChat && !hasNewSupportReply) {
        showPopup("No new messages or replies.");
        return;
    }

    if (hasNewSupportReply) {
        showSub('customerSupportSection');
        // Acknowledge the notification for support reply
        db.ref(`thunderPayUsers/${user}/hasNewSupportReply`).set(false);
        notificationDot.setAttribute('data-has-support-reply', 'false');
        showPopup("New reply from Customer Support!");
    } else if (hasNewChat && lastReceivedMessageSender) {
        openChat(lastReceivedMessageSender);
        // Acknowledge the notification for chat message
        db.ref(`thunderPayUsers/${user}/hasNewMessage`).set(false);
        db.ref(`thunderPayUsers/${user}/lastMessageFrom`).set("");
        notificationDot.setAttribute('data-has-chat-message', 'false');
    }
    updateNotificationBellVisibility(); // Re-evaluate bell visibility after action
}


// --- Customer Support Functions (User Side) ---
function submitCustomerSupportMessage() {
    const messageText = document.getElementById("customerSupportMessage").value.trim();
    if (!messageText) {
        alert("Please write your issue.");
        return;
    }

    const now = new Date().toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const messageData = {
        user: user,
        message: messageText,
        timestamp: now,
        status: 'pending',
        replies: []
    };

    db.ref("customerSupport").push(messageData)
        .then(() => {
            alert("Your issue has been sent. Owner will contact you soon.");
            document.getElementById("customerSupportMessage").value = "";
            // Set owner dot to true
            db.ref('ownerMessage/newSupportMessage').set(true);
        })
        .catch(error => {
            alert("Failed to send message: " + error.message);
            console.error("Customer support message failed:", error);
        });
}

// --- Customer Support Functions (Owner Side) ---
function listenForOwnerSupportMessages() {
    const ownerDot = document.getElementById('ownerDot');
    // Only owner sees the dot for support messages
    if (!user || user !== ownerPin) { // Check if the logged-in user is the owner
        ownerDot.classList.add('hidden');
        return;
    }
    
    // Detach existing listener if any to prevent multiple listeners
    if (ownerSupportListener) {
        db.ref('ownerMessage/newSupportMessage').off('value', ownerSupportListener);
    }

    ownerSupportListener = db.ref('ownerMessage/newSupportMessage').on('value', (snapshot) => {
        const hasNew = snapshot.val();
        if (hasNew) {
            ownerDot.classList.remove('hidden');
        } else {
            ownerDot.classList.add('hidden');
        }
    });
}


function loadCustomerSupportMessagesForOwner() {
    const customerServiceList = document.getElementById("customerServiceList");
    customerServiceList.innerHTML = '<div class="loader"></div>';

    db.ref("customerSupport").once("value", snap => {
        customerServiceList.innerHTML = "";
        if (!snap.exists()) {
            customerServiceList.innerHTML = "<p style='color:#cbd5e1;text-align:center;'>No customer support messages.</p>";
            return;
        }

        const messages = snap.val();
        Object.entries(messages).reverse().forEach(([key, data]) => { // Newest first
            const li = document.createElement("li");
            li.classList.add("customer-service-item");
            li.onclick = () => openCustomerSupportReply(key, data);
            
            let statusIndicator = '';
            if (data.status === 'pending') {
                statusIndicator = '<span style="color:#ffbf00;font-size:0.8em;font-weight:normal;float:right;">(Pending)</span>';
            } else if (data.status === 'replied') {
                statusIndicator = '<span style="color:#22c55e;font-size:0.8em;font-weight:normal;float:right;">(Replied)</span>';
            }

            li.innerHTML = `
                <h4>${data.user} ${statusIndicator}</h4>
                <p>Message: ${data.message}</p>
                <div class="timestamp">${data.timestamp}</div>
            `;
            customerServiceList.appendChild(li);
        });
    });
}

function openCustomerSupportReply(messageId, messageData) {
    customerSupportReplyId = messageId;
    document.getElementById("replyToUser").textContent = `Replying to: ${messageData.user}`;
    document.getElementById("customerServiceReplyText").value = "";
    document.getElementById("existingReplies").innerHTML = "";

    if (messageData.replies && messageData.replies.length > 0) {
        messageData.replies.forEach(reply => {
            const replyDiv = document.createElement("div");
            replyDiv.classList.add("reply-message");
            replyDiv.innerHTML = `<strong>${reply.sender}:</strong> ${reply.message} <br/><span style="font-size:0.8em;color:#94a3b8;">${reply.timestamp}</span>`;
            document.getElementById("existingReplies").appendChild(replyDiv);
        });
    } else {
        document.getElementById("existingReplies").innerHTML = "<p style='color:#cbd5e1;font-size:0.9em;'>No replies yet.</p>";
    }

    document.getElementById("customerServiceReplyBox").classList.remove("hidden");
}

function sendCustomerServiceReply() {
    const replyText = document.getElementById("customerServiceReplyText").value.trim();
    if (!replyText) {
        alert("Please write your reply.");
        return;
    }

    if (!customerSupportReplyId) {
        alert("No message selected.");
        return;
    }

    const now = new Date().toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const replyData = {
        sender: 'Owner',
        message: replyText,
        timestamp: now
    };

    db.ref(`customerSupport/${customerSupportReplyId}/replies`).push(replyData)
        .then(() => {
            // Also update the status to 'replied' if it was pending
            db.ref(`customerSupport/${customerSupportReplyId}`).update({ status: 'replied' });
            alert("Reply sent!");
            document.getElementById("customerServiceReplyText").value = "";
            loadCustomerSupportMessagesForOwner(); // Reload list to update status
            hideCustomerServiceReplyBox(); // Hide reply box after sending

            // Get the user whose message was replied to and set their hasNewSupportReply to true
            db.ref(`customerSupport/${customerSupportReplyId}/user`).once('value', userSnap => {
                const repliedToUser = userSnap.val();
                if (repliedToUser) {
                    db.ref(`thunderPayUsers/${repliedToUser}/hasNewSupportReply`).set(true);
                }
            });

            // Check if there are any other pending messages; if not, turn off the owner dot
            db.ref('customerSupport').once('value', (snap) => {
                const messages = snap.val() || {};
                const hasPending = Object.values(messages).some(msg => msg.status === 'pending');
                if (!hasPending) {
                    db.ref('ownerMessage/newSupportMessage').set(false);
                }
            });
        })
        .catch(error => {
            alert("Failed to send reply: " + error.message);
            console.error("Error sending customer service reply:", error);
        });
}

function hideCustomerServiceReplyBox() {
    document.getElementById("customerServiceReplyBox").classList.add("hidden");
    customerSupportReplyId = null;
}

// --- New Profile Functions ---
function loadMyProfile() {
    if (!user) return;

    document.getElementById("myProfileInitial").textContent = user.charAt(0).toUpperCase();
    document.getElementById("myProfileUsername").textContent = user;

    db.ref(`thunderPayUsers/${user}`).on('value', (snapshot) => { // Use .on for real-time updates
        const userData = snapshot.val();
        if (userData) {
            document.getElementById("profileBio").value = userData.bio || "";
            document.getElementById("myProfileFollowers").textContent = (userData.followers ? userData.followers.length : 0);
            document.getElementById("myProfileFollowing").textContent = (userData.following ? userData.following.length : 0);
        }
    });
}

function saveMyBio() {
    const bioText = document.getElementById("profileBio").value.trim();
    if (!user) return;

    db.ref(`thunderPayUsers/${user}/bio`).set(bioText)
        .then(() => {
            showPopup("Bio updated successfully!");
        })
        .catch(error => {
            alert("Failed to save bio: " + error.message);
            console.error("Error saving bio:", error);
        });
}

function openUserProfile(targetUsername) {
    currentProfileUser = targetUsername; // Set the user whose profile is being viewed
    showSub('otherUserProfileSection');
    loadOtherUserProfile(targetUsername);
}

function loadOtherUserProfile(targetUsername) {
    if (!targetUsername) return;

    document.getElementById("otherProfileInitial").textContent = targetUsername.charAt(0).toUpperCase();
    document.getElementById("otherProfileUsername").textContent = targetUsername;

    db.ref(`thunderPayUsers/${targetUsername}`).on('value', (snapshot) => { // Use .on for real-time updates
        const userData = snapshot.val();
        if (userData) {
            let usernameDisplay = targetUsername;
            if (userData.verified) {
                usernameDisplay += ' <span class="verified-badge">&#10003;</span>';
            }
            document.getElementById("otherProfileUsername").innerHTML = usernameDisplay; // Use innerHTML to render badge

            document.getElementById("otherProfileBio").textContent = userData.bio || "No bio available.";
            document.getElementById("otherProfileFollowers").textContent = (userData.followers ? userData.followers.length : 0);
            document.getElementById("otherProfileFollowing").textContent = (userData.following ? userData.following.length : 0);

            // Update Follow/Unfollow button
            db.ref(`thunderPayUsers/${user}/following`).once('value', myFollowingSnap => {
                const myFollowing = myFollowingSnap.val() || [];
                const followBtn = document.getElementById("otherProfileFollowBtn");
                if (myFollowing.includes(targetUsername)) {
                    followBtn.textContent = 'Unfollow';
                    followBtn.classList.remove('follow-btn');
                    followBtn.classList.add('unfollow-btn');
                } else {
                    followBtn.textContent = 'Follow';
                    followBtn.classList.remove('unfollow-btn');
                    followBtn.classList.add('follow-btn');
                }
            });
        } else {
            // User not found, handle gracefully
            document.getElementById("otherProfileUsername").textContent = targetUsername; // Reset to just username
            document.getElementById("otherProfileBio").textContent = "User not found.";
            document.getElementById("otherProfileFollowers").textContent = "N/A";
            document.getElementById("otherProfileFollowing").textContent = "N/A";
            document.getElementById("otherProfileFollowBtn").style.display = 'none'; // Hide button if user not found
        }
    });
}

function toggleFriendFromProfile() {
    if (currentProfileUser) {
        const followBtn = document.getElementById("otherProfileFollowBtn");
        toggleFriend(currentProfileUser, followBtn); // Pass the button element
    }
}

function openChatFromProfile() {
    if (currentProfileUser) {
        openChat(currentProfileUser);
    }
}

function prepareSendMoneyFromProfile() {
    if (currentProfileUser) {
        prepareSendMoney(currentProfileUser);
    }
}

// --- Chat Content Picker Functions (Emojis, Stickers, Gifts) ---
function initializeChatContentPicker() {
    const picker = document.getElementById("chatContentPicker");
    picker.innerHTML = ''; // Clear previous content

    // Add Emojis
    emojis.forEach(emoji => {
        const button = document.createElement("button");
        button.textContent = emoji;
        button.onclick = () => addChatContentToInput(emoji);
        picker.appendChild(button);
    });

    // Add a separator or title for Stickers/Gifts if desired
    // const separator = document.createElement('div');
    // separator.textContent = 'Stickers & Gifts';
    // separator.style = 'grid-column: 1 / -1; text-align: center; color: #ffbf00; margin-top: 10px; font-weight: bold;';
    // picker.appendChild(separator);

    // Add Stickers and Gifts
    stickersAndGifts.forEach(item => {
        const div = document.createElement("div");
        if (item.type === 'sticker') {
            div.className = `sticker-item ${item.styleClass}`;
            div.textContent = item.content;
            div.onclick = () => addChatContentToInput(item.content);
        } else if (item.type === 'gift') {
            div.className = `gift-item`;
            div.textContent = item.content;
            div.onclick = () => addChatContentToInput(item.content);
        }
        picker.appendChild(div);
    });
}

function toggleChatContentPicker() {
    const picker = document.getElementById("chatContentPicker");
    picker.style.display = picker.style.display === "grid" ? "none" : "grid";
    if (picker.style.display === "grid") {
        document.getElementById("chatInput").focus(); // Keep focus on input
    }
}

function addChatContentToInput(content) {
    const chatInput = document.getElementById("chatInput");
    chatInput.value += content;
    chatInput.focus();
}

// --- Message Reaction Functions ---
function toggleMessageReaction(messageId, emoji) {
    if (!chatRef || !messageId) return;

    const messagePath = chatRef.child(messageId);

    messagePath.child('reactions').child(emoji).once('value', (snapshot) => {
        let usersReacted = snapshot.val() || [];
        if (!Array.isArray(usersReacted)) { // Handle case if reactions was not an array before
            usersReacted = [];
        }

        const userIndex = usersReacted.indexOf(user);

        if (userIndex > -1) {
            // User already reacted with this emoji, remove reaction
            usersReacted.splice(userIndex, 1);
        } else {
            // User has not reacted with this emoji, add reaction
            usersReacted.push(user);
        }

        if (usersReacted.length > 0) {
            messagePath.child('reactions').child(emoji).set(usersReacted);
        } else {
            // If no users left for this emoji, remove the emoji entry
            messagePath.child('reactions').child(emoji).remove();
        }
    });
}

// --- Mailbox Functions (New) ---
function loadMailboxMessages() {
    const mailboxDisplay = document.getElementById("mailboxDisplay");
    mailboxDisplay.innerHTML = '<div class="loader"></div>'; // Show loader

    // Detach previous listener if exists to prevent duplicates
    if (mailboxListener) {
        db.ref(`thunderPayUsers/${user}/mailbox`).off('child_added', mailboxListener);
        db.ref(`thunderPayUsers/${user}/mailbox`).off('child_removed', mailboxListener);
    }
    
    // Use 'on' to get real-time updates for messages (new or removed)
    mailboxListener = db.ref(`thunderPayUsers/${user}/mailbox`).on('value', (snapshot) => {
        mailboxDisplay.innerHTML = ""; // Clear loader and previous messages
        const messages = snapshot.val();

        if (!messages || Object.keys(messages).length === 0) {
            const p = document.createElement("p");
            p.classList.add("no-messages");
            p.textContent = "Your mailbox is empty.";
            mailboxDisplay.appendChild(p);
            return;
        }

        const messageKeys = Object.keys(messages).sort((a, b) => messages[b].timestamp.localeCompare(messages[a].timestamp)); // Sort by timestamp, newest first

        messageKeys.forEach(key => {
            const msgData = messages[key];
            const div = document.createElement("div");
            div.classList.add("mailbox-message-item");
            if (!msgData.read) {
                div.style.fontWeight = 'bold'; // Highlight unread messages
                div.style.backgroundColor = '#334155'; // Slightly different background for unread
            }
            div.innerHTML = `
                <h4>${msgData.subject || 'No Subject'} from ${msgData.sender}</h4>
                <p>${msgData.message}</p>
                <div class="timestamp">${msgData.timestamp}</div>
            `;
            div.onclick = () => markMailboxMessageAsRead(key); // Mark as read on click
            mailboxDisplay.appendChild(div);
        });
    });
}

function markMailboxMessageAsRead(messageKey) {
    if (!user) return;
    db.ref(`thunderPayUsers/${user}/mailbox/${messageKey}/read`).set(true)
        .then(() => {
            console.log(`Message ${messageKey} marked as read.`);
            // No need to reload mailbox, the 'on' listener will update the display automatically
        })
        .catch(error => {
            console.error("Error marking message as read:", error);
        });
}


// Initial setup on page load
window.addEventListener("load", function() {
    // Firebase Realtime Database 'presence' system
    const presenceRef = firebase.database().ref('.info/connected');
    
    // Listen for connection status changes
    presenceRef.on('value', function(snapshot) {
      if (snapshot.val() === true && user) { // If connected and user is logged in
        const userStatusRef = db.ref('thunderPayUsers/' + user + '/status');
        userStatusRef.onDisconnect().set(false); // Set offline when disconnected
        userStatusRef.set(true); // Set online
      }
    });

    // Handle browser tab/window close or refresh to set status offline
    window.addEventListener('beforeunload', function() {
      if (user) {
          db.ref(`thunderPayUsers/${user}/status`).set(false); // Set offline immediately
      }
    });

    initializeChatContentPicker(); // Initialize chat content picker on load
});


function sendReward() {
  const ru = document.getElementById("rewardUser").value.trim();
  const ra = document.getElementById("rewardAmount").value.trim();
  const rm = document.getElementById("rewardMessage").value.trim();
  if (!ru || !ra || !rm) return alert("Please fill all fields.");

  const now = new Date().toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  }).replace(',', '');

  const rewardData = {
    amount: ra,
    message: rm,
    time: now,
    from: "Owner"
  };

  const rewardKey = db.ref(`thunderPayUsers/${ru}/mailbox`).push().key;
  db.ref(`thunderPayUsers/${ru}/mailbox/${rewardKey}`).set(rewardData)
    .then(() => {
      alert("üéÅ Reward sent to " + ru + "'s mailbox!");
      document.getElementById("rewardUser").value = "";
      document.getElementById("rewardAmount").value = "";
      document.getElementById("rewardMessage").value = "";
    })
    .catch(err => alert("‚ùå Failed to send reward: " + err.message));
}


function loadMailboxMessages() {
  const container = document.getElementById("mailboxDisplay");
  container.innerHTML = '<p class="no-messages">Loading...</p>';

  db.ref(`thunderPayUsers/${user}/mailbox`).once("value", snap => {
    container.innerHTML = "";
    if (!snap.exists()) {
      container.innerHTML = '<p class="no-messages">No messages in your mailbox.</p>';
      return;
    }

    const all = snap.val();
    Object.entries(all).reverse().forEach(([key, data]) => {
      const item = document.createElement("div");
      item.className = "mailbox-message-item";
      item.innerHTML = `
        <h4>üéÅ Reward from ${data.from || 'Unknown'}</h4>
        <p>${data.message}</p>
        <p><b>Amount / Gift:</b> ‚Çπ${data.amount}</p>
        <p class="timestamp">${data.time}</p>
        <button onclick="claimReward('${key}', '${data.amount}')">üéâ Claim</button>
      `;
      container.appendChild(item);
    });
  });
}

function claimReward(key, amt) {
  const amount = parseInt(amt);
  if (!user || !key || isNaN(amount)) return alert("Invalid reward data.");

  db.ref("thunderPayUsers/" + user).once("value", snap => {
    if (!snap.exists()) return alert("User not found.");
    const bal = snap.val().balance || 0;
    const now = new Date().toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const updates = {};
    updates[`thunderPayUsers/${user}/balance`] = bal + amount;
    updates[`thunderPayUsers/${user}/history/${db.ref().push().key}`] = `${now} | Got ‚Çπ${amount} from Owner Reward`;
    updates[`thunderPayUsers/${user}/mailbox/${key}`] = null;

    db.ref().update(updates).then(() => {
      
    
      loadMailboxMessages();
      showPaymentSuccessAnimation();
    });
  });
}


function saveProfileEmoji() {
  const emoji = document.getElementById("profileEmojiSelect").value;
  db.ref(`thunderPayUsers/${user}/emoji`).set(emoji).then(() => {
    alert("‚úÖ Emoji Saved!");
    loadMyProfile();
  });
}

function loadMyProfile() {
  db.ref(`thunderPayUsers/${user}`).once("value", snap => {
    const data = snap.val();
    const emoji = data.emoji || "";
    const username = user;
    document.getElementById("myProfileUsername").innerHTML = username + (data.verified ? '<span class="verified-badge">‚úì</span>' : "");
    document.getElementById("myProfileInitial").textContent = emoji || username.charAt(0).toUpperCase();
    document.getElementById("profileBio").value = data.bio || "";
    document.getElementById("myProfileFollowers").textContent = data.followers ? Object.keys(data.followers).length : 0;
    document.getElementById("myProfileFollowing").textContent = data.following ? Object.keys(data.following).length : 0;
    if (document.getElementById("profileEmojiSelect")) {
      document.getElementById("profileEmojiSelect").value = emoji;
    }
  });
}


function monitorMailbox() {
  if (!user) return;
  const dot = document.getElementById("mailboxDot");
  const gift = document.getElementById("giftIcon");
  db.ref(`thunderPayUsers/${user}/mailbox`).on("value", snap => {
    if (snap.exists()) {
      dot.classList.remove("hidden");
      gift.style.display = "inline";
    } else {
      dot.classList.add("hidden");
      gift.style.display = "none";
    }
  });
}


// ‚úÖ SEARCH FUNCTIONALITY FOR MEMBERS & FRIEND LIST
function filterUserList() {
  const query = document.getElementById("userSearchInput").value.toLowerCase();
  const currentTab = document.querySelector(".user-list-tab-content:not(.hidden)");
  const list = currentTab.querySelectorAll("li");
  list.forEach(li => {
    const text = li.textContent.toLowerCase();
    li.style.display = text.includes(query) ? "" : "none";
  });
}

// ‚úÖ EMOJI FIX FOR OTHER USER PROFILE VIEW
function loadOtherUserProfile(username) {
  currentProfileUser = username;
  db.ref("thunderPayUsers/" + username).once("value", snap => {
    const data = snap.val();
    if (!data) return alert("User not found");

    const emoji = data.emoji || username.charAt(0).toUpperCase();
    document.getElementById("otherProfileInitial").textContent = emoji;
    document.getElementById("otherProfileUsername").innerHTML = username + (data.verified ? '<span class="verified-badge">‚úì</span>' : "");
    document.getElementById("otherProfileBio").textContent = data.bio || "No bio available.";
    document.getElementById("otherProfileFollowers").textContent = data.followers ? Object.keys(data.followers).length : 0;
    document.getElementById("otherProfileFollowing").textContent = data.following ? Object.keys(data.following).length : 0;

    showSub("otherUserProfileSection");
  });
}
   </script>
<script>
    function monitorMailbox() {
  if (!user) return;
  const dot = document.getElementById("mailboxDot");
  const gift = document.getElementById("giftIcon");
  db.ref(`thunderPayUsers/${user}/mailbox`).on("value", snap => {
    if (snap.exists()) {
      dot.classList.remove("hidden");
      dot.classList.add("animated");
      gift.style.display = "inline";
      playNotificationTone();
    } else {
      dot.classList.add("hidden");
      dot.classList.remove("animated");
      gift.style.display = "none";
    }
  });
}
   </script>
<script>
    let typingTimeout;

function handleTyping(event) {
  if (event.keyCode === 13) {
    sendMessage();
    return;
  }
  if (!user || !currentChatPartner) return;
  db.ref(`chats/${user}_${currentChatPartner}/typing`).set(true);
  clearTimeout(typingTimeout);
  typingTimeout = setTimeout(() => {
    db.ref(`chats/${user}_${currentChatPartner}/typing`).set(false);
  }, 1000);
}

function monitorTypingStatus() {
  if (!user || !currentChatPartner) return;
  const typingRef = db.ref(`chats/${currentChatPartner}_${user}/typing`);
  typingRef.on('value', snap => {
    document.getElementById("typingIndicator").style.display = snap.val() ? "block" : "none";
  });
}

function markMessagesSeen() {
  if (!user || !currentChatPartner) return;
  const chatPath = `chats/${currentChatPartner}_${user}`;
  db.ref(chatPath).once('value', snap => {
    snap.forEach(child => {
      if (!child.val().seen && child.val().from !== user) {
        db.ref(`${chatPath}/${child.key}/seen`).set(true);
      }
    });
  });
}

// Optional: Hook this into your message rendering logic
function renderMessage(msg) {
  const messageEl = document.createElement("p");
  messageEl.className = msg.from === user ? "my-message" : "other-message";
  if (msg.seen && msg.from === user) messageEl.classList.add("seen");
  messageEl.textContent = msg.text;
  document.getElementById("messagesDisplay").appendChild(messageEl);
}
   </script>
<script>
    function toggleOwnerSection(id) {
  const all = ['ownerAddCode','ownerAddMoney','ownerSetMessage','ownerVerify','ownerSendReward','ownerAnalytics','ownerSupport'];
  all.forEach(sec => {
    document.getElementById(sec).style.display = (sec === id && document.getElementById(sec).style.display !== 'block') ? 'block' : 'none';
  });
}
   </script>
<script>
    function loadUserAnalytics() {
  const results = document.getElementById("analyticsResults");
  results.innerHTML = "Loading...";
  const today = new Date().toISOString().split('T')[0];
  db.ref("thunderPayUsers").once("value", snap => {
    if (!snap.exists()) return results.innerHTML = "No users found.";
    const data = snap.val();
    let dailyUsers = [];
    let topSpenders = [];
    let userDetails = [];

    for (let [username, info] of Object.entries(data)) {
      const todayFormatted = new Date().toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
      if (info.lastLoginDateStr === todayFormatted) dailyUsers.push(username);
      topSpenders.push({ name: username, time: info.totalTimeSpent || 0 });
      userDetails.push({ name: username, pass: info.password || "-", bal: info.balance || 0 });
    }

    topSpenders.sort((a, b) => b.time - a.time);

    results.innerHTML = `
      <div class="tab-container">
        <button class="tab-button active" onclick="switchAnalyticsTab('dailyActiveTab', this)">üë• Daily Active</button>
        <button class="tab-button" onclick="switchAnalyticsTab('topSpendersTab', this)">üé® Top Creators</button>
        <button class="tab-button" onclick="switchAnalyticsTab('userDetailsTab', this)">üîê Credentials</button>
      </div>

      <div id="dailyActiveTab" class="history-tab-content">
        <h3>üìÖ Users Active Today</h3>
        <ul id="transactionList">
          ${dailyUsers.map(u => `<li class="transaction-item"><div class="transaction-details"><div class="transaction-main-text">${u}</div><div class="transaction-sub-text">Active Today</div></div></li>`).join("") || '<li class="transaction-item">No active users today</li>'}
        </ul>
      </div>

      <div id="topSpendersTab" class="history-tab-content hidden">
        <h3>‚è±Ô∏è Top Creators</h3>
        <ul id="transactionList">
          ${topSpenders.slice(0, 5).map(u => `<li class="transaction-item"><div class="transaction-details"><div class="transaction-main-text">${u.name}</div><div class="transaction-sub-text">${Math.floor(u.time / 60)} minutes</div></div></li>`).join("")}
        </ul>
      </div>

      <div id="userDetailsTab" class="history-tab-content hidden">
        <h3>üîê User Credentials</h3>
        <ul id="transactionList">
          ${userDetails.map(u => `<li class="transaction-item"><div class="transaction-details"><div class="transaction-main-text">${u.name}</div><div class="transaction-sub-text">Pass: ${u.pass} | ‚Çπ${u.bal}</div></div></li>`).join("")}
        </ul>
      </div>
    `;
  });
}

function switchAnalyticsTab(tabId, btn) {
  const tabs = ["dailyActiveTab", "topSpendersTab", "userDetailsTab"];
  tabs.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.add("hidden");
  });
  const showEl = document.getElementById(tabId);
  if (showEl) showEl.classList.remove("hidden");

  const buttons = btn.parentElement.querySelectorAll(".tab-button");
  buttons.forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
}
   </script>
<script>
    function changeBackgroundColor() {
        // Predefined colors: White, Red, and Blue
        const colors = ['#ffffff', '#ff0000', '#0000ff'];
        // Randomly select a color
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        // Change the background color of the body
        document.body.style.backgroundColor = randomColor;
    }
   </script>
<style>
    /* ASMR Theme - Soft colors, smooth background, relaxing design */
    body {
        background: linear-gradient(to right, #e0c3fc, #8ec5fc); /* Smooth gradient */
        color: #4a4a4a; /* Soft text color */
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        margin: 0;
        text-align: center;
    }

    #messagesDisplay {
        background-color: rgba(255, 255, 255, 0.7); /* Soft, semi-transparent background */
        color: #333;
        border-radius: 12px;
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        font-size: 1.1em;
        line-height: 1.6;
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #8ec5fc;
    }

    #messagesDisplay p {
        margin: 10px 0;
        padding: 12px 20px;
        border-radius: 20px;
        background-color: #ffffff;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        max-width: 80%;
        word-wrap: break-word;
    }

    .my-message {
        background-color: #f3d9ff; /* Light lavender for my message */
        color: #4a4a4a;
        margin-left: auto;
        text-align: right;
        border-bottom-right-radius: 10px;
        border: 2px solid #8ec5fc;
    }

    .other-message {
        background-color: #b6f0ff; /* Soft light blue for other messages */
        color: #4a4a4a;
        margin-right: auto;
        text-align: left;
        border-bottom-left-radius: 10px;
        border-left: 2px solid #8ec5fc;
    }

    .message-timestamp {
        font-size: 0.8em;
        color: #8ec5fc;
        margin-top: 5px;
        display: block;
    }

    #chatInputContainer {
        background-color: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
        width: 100%;
        max-width: 600px;
        margin: 20px auto;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    #chatInputContainer input {
        background-color: #f9f9f9;
        color: #4a4a4a;
        border: 1px solid #8ec5fc;
        border-radius: 20px;
        padding: 12px;
        width: 80%;
        font-size: 1em;
    }

    #chatInputContainer button {
        background-color: #8ec5fc;
        color: white;
        padding: 12px 18px;
        border-radius: 20px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
    }

    #chatInputContainer button:hover {
        background-color: #7db8e6;
    }

    #chatInputContainer button:active {
        background-color: #69a2c0;
    }

.jio-icon {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background-color: #ff0000;
  color: white;
  font-weight: bold;
  font-size: 18px;
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 10px;
}
   </style>
<script>
    function broadcastGiftCode() {
  const code = document.getElementById("specialGiftCodeInput").value.trim();
  const msg = document.getElementById("specialGiftMessage").value.trim();
  if (!code || !msg) return alert("Please fill in both code and message");

  const data = { code, message: msg };
  db.ref("specialGiftBroadcast").set(data)
    .then(() => alert("‚úÖ Special Gift Code broadcasted to all users!"))
    .catch(err => alert("‚ùå Failed: " + err.message));
}

function loadSpecialGiftCode() {
  db.ref("specialGiftBroadcast").on("value", snap => {
    const val = snap.val();
    if (!val) return;
    const container = document.getElementById("specialGiftArea");
    container.innerHTML = `<div style="background:#1e293b;padding:15px;border-radius:10px;margin-top:20px;">
      <h3 style="color:#ffbf00">üéØ Special Gift Code</h3>
      <p style="color:#00ffbb;font-size:1.2em;">${val.code}</p>
      <p style="color:#cbd5e1;">${val.message}</p>
    </div>`;
  });
}
   </script>
<script>
    // üîê Owner adds a special gift code
function addSpecialCode() {
  const code = document.getElementById("specialGiftCodeInput").value.trim();
  const amount = document.getElementById("specialGiftAmountInput").value.trim();

  if (!code || !amount) return alert("Please enter both code and amount.");
  db.ref("specialGiftCodes/" + code).set({
    amount: parseInt(amount),
    used: false
  }).then(() => {
    alert("‚úÖ Special code added successfully!");
    document.getElementById("specialGiftCodeInput").value = "";
    document.getElementById("specialGiftAmountInput").value = "";
  }).catch(err => {
    alert("‚ùå Error: " + err.message);
  });
}

// üéÅ User applies the special code
function applySpecialCode() {
  const code = prompt("Enter special code:");
  if (!code) return;

  db.ref("specialGiftCodes/" + code).once("value", snap => {
    if (!snap.exists()) return alert("‚ùå Invalid code.");
    const data = snap.val();
    if (data.used) return alert("‚ùå This code has already been used.");

    db.ref("thunderPayUsers/" + user).once("value", userSnap => {
      if (!userSnap.exists()) return alert("User not found.");
      const bal = userSnap.val().balance || 0;
      const now = new Date().toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).replace(',', '');

      const updates = {};
      updates[`thunderPayUsers/${user}/balance`] = bal + parseInt(data.amount);
      updates[`thunderPayUsers/${user}/history/${db.ref().push().key}`] = `${now} | Claimed Special Code ‚Çπ${data.amount}`;
      updates[`specialGiftCodes/${code}/used`] = true;

      db.ref().update(updates).then(() => {
        alert("üéâ Special code applied successfully!");
        loadUserData();
      });
    });
  });
}
   </script>
<script>
    function addBulkSpecialCodes() {
  const codes = ["Xcf", "Gdj", "Vjk", "Fgy", "Itna", "Fui", "Dikh", "Rub", "Fkug", "Gunfy", "Ruguu", "Fitn"];
  const dbRef = firebase.database().ref("specialGiftCodes");

  codes.forEach(code => {
    dbRef.child(code).set({
      amount: 5,
      used: false
    });
  });

  alert("‚úÖ All 5 rupees special codes have been added!");
}
   </script>
<script>
    function applySpecialCode() {
  const code = prompt("Enter your special code:");
  if (!code) return;

  const dbRef = firebase.database().ref("specialGiftCodes/" + code);

  dbRef.once("value", snap => {
    if (!snap.exists()) return alert("‚ùå Invalid code.");

    const data = snap.val();

    if (data.used) return alert("‚ùå Code already used.");

    const userRef = firebase.database().ref("thunderPayUsers/" + user);

    userRef.once("value", userSnap => {
      if (!userSnap.exists()) return alert("‚ùå User not found.");
      
      const userData = userSnap.val();
      const balance = userData.balance || 0;
      const now = new Date().toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
      }).replace(',', '');

      const updates = {};
      updates[`thunderPayUsers/${user}/balance`] = balance + parseInt(data.amount);
      updates[`thunderPayUsers/${user}/history/${firebase.database().ref().push().key}`] = `${now} | Claimed ‚Çπ${data.amount} from Special Code`;
      updates[`specialGiftCodes/${code}/used`] = true;

      firebase.database().ref().update(updates).then(() => {
        alert("‚úÖ Code applied successfully! ‚Çπ" + data.amount + " added to your balance.");
        // showSpecialCodesPublic (disabled)();
      }).catch(err => {
        alert("‚ùå Error: " + err.message);
      });

    });
  });
}
   </script>
<script>
    function addCustomBulkCodes() {
  const rawCodes = document.getElementById("bulkCodeList").value.trim();
  const amount = parseInt(document.getElementById("bulkCodeAmount").value.trim());

  if (!rawCodes || isNaN(amount)) {
    alert("‚ùå Please enter valid amount and at least one code.");
    return;
  }

  const codes = rawCodes.split(/[,\n]+/).map(c => c.trim()).filter(c => c);
  if (codes.length === 0) {
    alert("‚ùå No valid codes found.");
    return;
  }

  const dbRef = firebase.database().ref("specialGiftCodes");
  codes.forEach(code => {
    dbRef.child(code).set({
      amount: amount,
      used: false
    });
  });

  alert(`‚úÖ ${codes.length} code(s) added successfully with ‚Çπ${amount} each!`);
  document.getElementById("bulkCodeList").value = "";
  document.getElementById("bulkCodeAmount").value = "";
}
   </script>
<script>
    function toggleOwnerSection(id) {
  const sections = ['ownerAddCode', 'ownerAddMoney', 'ownerSetMessage', 'ownerVerify', 'ownerSendReward', 'ownerAnalytics', 'ownerSpecialGiftCode', 'ownerSupport', 'ownerBulkMsg'];
  sections.forEach(sec => {
    const el = document.getElementById(sec);
    if (el) el.style.display = (sec === id) ? 'block' : 'none';
  });
}
   </script>
</div>
<!-- End of fixed body -->
<script>
   function hideChatbotAndGoBack() {
    document.getElementById("chatbotContent").style.display = "none";
    showScreen('dash');
  }
  </script>
<script>
   function purchaseRecharge(planName, amount) {
  const phone = prompt("Enter phone number for " + planName);
  if (!phone || phone.trim().length < 10) return alert("Invalid phone number!");
  if (!confirm("Recharge " + planName + " on number: " + phone + "?")) return;

  const now = new Date().toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  }).replace(',', '');

  const purchaseRef = db.ref("thunderPayUsers/" + user);
  purchaseRef.once("value").then(snap => {
    const bal = snap.val().balance || 0;
    if (bal < amount) return alert("Insufficient balance!");

    const updates = {};
    updates[`thunderPayUsers/${user}/balance`] = bal - amount;
    updates[`thunderPayUsers/${user}/history/${db.ref().push().key}`] = `${now} | Recharged ${planName} on ${phone}`;
    updates[`thunderPayUsers/${user}/purchase/${db.ref().push().key}`] = `${now} | Jio Recharge ‚Çπ${amount} | ${phone}`;

    db.ref().update(updates).then(() => {
      showPaymentSuccessAnimation();
    });
  });
}
  </script>
<script>
function purchaseRecharge(planName, amount) {
  const phone = prompt("üì± Enter Mobile Number for " + planName + ":");
  if (!phone || !/^\d{10}$/.test(phone)) return alert("‚ùå Please enter a valid 10-digit number");

  const confirmMsg = `Confirm recharge:\n\nNumber: ${phone}\nPlan: ${planName}\nAmount: ‚Çπ${amount}`;
  if (!confirm(confirmMsg)) return;

  db.ref("thunderPayUsers/" + user).once("value", snap => {
    if (!snap.exists()) return alert("User not found");
    const bal = snap.val().balance || 0;
    if (bal < amount) return alert("‚ùå Insufficient balance");

    const now = new Date().toLocaleString('en-IN', {
      day: '2-digit', month: 'short', year: 'numeric',
      hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');

    const orderKey = db.ref("rechargeOrders").push().key;
    const updates = {};
    updates[`rechargeOrders/${orderKey}`] = {
      username: user,
      phone,
      plan: planName,
      amount,
      time: now
    };
    updates[`thunderPayUsers/${user}/balance`] = bal - amount;
    updates[`thunderPayUsers/${user}/history/${db.ref().push().key}`] = `${now} | Recharge Order: ‚Çπ${amount} (${planName}) to ${phone}`;

    db.ref().update(updates).then(() => {
      showPaymentSuccessAnimation();
      alert("‚úÖ Recharge order placed! Owner will process it shortly.");
    });
  });
}

function loadRechargeOrders() {
  const container = document.getElementById("rechargeOrderList");
  container.innerHTML = '<p style="text-align:center; color:#94a3b8;">Loading orders...</p>';
  db.ref("rechargeOrders").once("value", snap => {
    container.innerHTML = "";
    if (!snap.exists()) return container.innerHTML = '<p style="text-align:center; color:#94a3b8;">No new recharge orders.</p>';

    const orders = snap.val();
    Object.entries(orders).reverse().forEach(([key, data]) => {
      const div = document.createElement("div");
      div.className = "mailbox-message-item";
      div.innerHTML = `
        <h4>üì≤ Recharge Request</h4>
        <p><b>User:</b> ${data.username}</p>
        <p><b>Number:</b> ${data.phone}</p>
        <p><b>Plan:</b> ${data.plan}</p>
        <p><b>Amount:</b> ‚Çπ${data.amount}</p>
        <p class="timestamp">${data.time}</p>
      `;
      container.appendChild(div);
    });
  });
}
</script>
<!-- ‚úÖ Recharge Orders Section -->
<div class="section hidden" id="rechargeOrdersSection">
<h3>üì≤ New Recharge Orders</h3>
<div id="rechargeOrderList"></div>
<button onclick="showSub('owner')">‚¨Ö Back to Owner Panel</button>
</div>
<script>
function switchTab(tabId) {
    document.getElementById('homeTab').style.display = 'none';
    document.getElementById('exploreTab').style.display = 'none';
    document.getElementById('payTab').style.display = 'none';
    document.getElementById(tabId).style.display = 'block';
}
function showBottomNav() {
    document.getElementById('bottomNav').style.display = 'flex';
}
// Call showBottomNav() after successful login
</script><script>
let likedTweets = {};

function postTweet() {
    const tweetText = document.getElementById("tweetInput").value.trim();
    if (!tweetText) return alert("Please write something to tweet!");
    const now = new Date().toLocaleString('en-IN', {
        day: '2-digit', month: 'short', year: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
    }).replace(',', '');
    const tweetData = {
        user: user,
        text: tweetText,
        time: now,
        likes: 0,
        likedBy: {}
    };
    const newTweetKey = db.ref("tweets").push().key;
    db.ref("tweets/" + newTweetKey).set(tweetData).then(() => {
        document.getElementById("tweetInput").value = "";
    }).catch(err => alert("Error posting tweet: " + err.message));
}

function likeTweet(tweetId, currentLikes, likedBy) {
    if (likedBy && likedBy[user]) {
        return alert("You already liked this tweet!");
    }
    const updates = {};
    updates["tweets/" + tweetId + "/likes"] = currentLikes + 1;
    updates["tweets/" + tweetId + "/likedBy/" + user] = true;
    db.ref().update(updates);
}

function loadTweets() {
    const tweetsList = document.getElementById("tweetsList");
    db.ref("tweets").on("value", snap => {
        tweetsList.innerHTML = "";
        if (!snap.exists()) {
            tweetsList.innerHTML = "<p style='color:#555;'>No tweets yet.</p>";
            return;
        }
        const tweets = Object.entries(snap.val()).sort((a,b) => b[1].likes - a[1].likes);
        tweets.forEach(([key, data]) => {
            const tweetCard = document.createElement("div");
            tweetCard.style.background = "#ffffff";
            tweetCard.style.color = "#000";
            tweetCard.style.borderRadius = "12px";
            tweetCard.style.padding = "12px";
            tweetCard.style.marginBottom = "10px";
            tweetCard.style.boxShadow = "0 4px 10px rgba(0,0,0,0.1)";
            tweetCard.innerHTML = `
                <div style="display:flex; align-items:center; justify-content:space-between;">
                    <b style="color:#000; font-size:1.1em;">${data.user}</b>
                    <span style="font-size:0.8em; color:#666;">${data.time}</span>
                </div>
                <p style="font-size:1em; margin:8px 0;">${data.text}</p>
                <span style="cursor:pointer; font-size:1.2em; color:${data.likedBy && data.likedBy[user] ? 'red' : '#888'};" onclick="likeTweet('${key}', ${data.likes || 0}, ${JSON.stringify(data.likedBy || {})})">
                    ‚ù§Ô∏è ${data.likes || 0}
                </span>
            `;
            tweetsList.appendChild(tweetCard);
        });
    });
}

document.querySelector("button[onclick=\"switchTab('exploreTab')\"]").addEventListener("click", loadTweets);
</script>
<script>
// Autologin check
document.addEventListener("DOMContentLoaded", function() {
    const savedUser = localStorage.getItem("savedUser");
    const savedPass = localStorage.getItem("savedPass");
    if (savedUser && savedPass) {
        login(savedUser, savedPass, true);
    }
});

// Modified login function to support autologin
function login(u, p, auto=false) {
    const username = auto ? u : document.getElementById("lUser").value.trim();
    const password = auto ? p : document.getElementById("lPass").value.trim();
    if (!username || !password) return alert("Please fill all fields.");

    db.ref("thunderPayUsers/" + username).once("value", snap => {
        if (!snap.exists() || snap.val().password !== password) {
            return alert("Wrong username or password!");
        }
        user = username;
        if (!auto) {
            localStorage.setItem("savedUser", username);
            localStorage.setItem("savedPass", password);
        }
        showScreen('dash');
        loadDashboard();
    });
}

// Modified logout to clear saved login
function logout() {
    localStorage.removeItem("savedUser");
    localStorage.removeItem("savedPass");
    user = null;
    showScreen('chooser');
}
</script>
<script>
function showNewsOnHome(){
  const target = document.getElementById("newsContent");
  if (!target) return;
  db.ref("news/latest").on("value", snap => {
    if (!snap.exists()) { target.innerHTML = "No news available."; return; }
    target.innerHTML = `<div style='background:#f87171; color:white; padding:10px; border-radius:10px;'>${snap.val()}</div>`;
  });
}
document.addEventListener('DOMContentLoaded', showNewsOnHome);
</script>
<script>
function addNews(){
  let newsText = prompt("Enter news content:");
  if(!newsText) return alert("News content cannot be empty!");
  const newsRef = firebase.database().ref("news/latest");
  newsRef.set(newsText)
    .then(() => alert("‚úÖ News updated successfully!"))
    .catch(e => alert("‚ùå Failed to update news: " + e.message));
}
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Run check every time exploreTab is displayed
    const tabs = document.querySelectorAll('#homeTab, #exploreTab, #payTab');
    tabs.forEach(tab => {
        const observer = new MutationObserver(() => {
            if (document.getElementById('exploreTab').style.display !== 'none') {
                showSub('userListSection');
                showAllUsers();
            }
        });
        observer.observe(tab, { attributes: true, attributeFilter: ['style'] });
    });
});
</script></body>
</html>
<script>
 function switchAnalyticsTab(tabId, btn) {
  document.querySelectorAll(".history-tab-content").forEach(e => e.classList.add("hidden"));
  document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
  document.getElementById(tabId).classList.remove("hidden");
  btn.classList.add("active");
}
</script>
<script>
 function loadUserTrackingData() {
  const container = document.getElementById("analyticsResults");
  db.ref("loginTracking").orderByChild("timestamp").limitToLast(50).once("value", snap => {
    if (!snap.exists()) {
      container.innerHTML += "<p>No login data found.</p>";
      return;
    }
    let html = '<h4>Recent User Logins</h4><ul style="list-style:none; padding-left:0">';
    Object.entries(snap.val()).reverse().forEach(([key, val]) => {
      html += `<li style="margin-bottom:6px; background:#334155; padding:8px 10px; border-radius:8px">üë§ <b>${val.username}</b> logged in at <span style="color:#ffbf00">${val.timeStr}</span></li>`;
    });
    html += '</ul>';
    container.innerHTML += html;
  });
}

// Modify loadUserAnalytics to also include tracking data
const oldLoadUserAnalytics = loadUserAnalytics;
loadUserAnalytics = function() {
  oldLoadUserAnalytics();
  loadUserTrackingData();
}
</script>
<script>
 function toggleChatbot() {
    const chatbotContent = document.getElementById("chatbotContent");
    if (chatbotContent.style.display === "none" || chatbotContent.style.display === "") {
      chatbotContent.style.display = "block"; // Show the content
      document.getElementById('openChatbot').innerText = "Close Chatbot & Q&A"; // Change button text
    } else {
      chatbotContent.style.display = "none"; // Hide the content
      document.getElementById('openChatbot').innerText = "Chatbot & Q&A"; // Revert button text
    }
  }
</script>
<script>
function markRechargeOrderAsDone(username, orderKey, plan) {
  const now = new Date().toLocaleString('en-IN', {
    day: '2-digit', month: 'short', year: 'numeric',
    hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
  }).replace(',', '');

  const msg = {
    amount: "0",
    message: `Your recharge for ${plan} is successfully done ‚úÖ`,
    time: now,
    from: "THUNDERXPAY"
  };

  const mailboxKey = db.ref(`thunderPayUsers/${username}/mailbox`).push().key;

  const updates = {};
  updates[`thunderPayUsers/${username}/mailbox/${mailboxKey}`] = msg;
  updates[`rechargeOrders/${username}/${orderKey}`] = null;

  db.ref().update(updates).then(() => {
    alert(`‚úÖ Recharge marked as done & user notified (${username})`);
    loadRechargeOrders(); // Refresh list
  }).catch(err => {
    alert("‚ùå Failed: " + err.message);
  });
}
</script>
